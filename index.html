<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Despliegue</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root{--bg:#080b0f;--bg2:#0e1219;--bg3:#131820;--bg4:#1a2130;--border:#232f40;--border2:#2e3f58;--gold:#c9a84c;--gold2:#e8c97a;--gold3:#f5dfa0;--red:#c94c4c;--red2:#e87a7a;--blue:#4c7ec9;--blue2:#7aaae8;--teal:#4ca8a0;--teal2:#7accc4;--purple:#8a4cc9;--purple2:#b47ae8;--orange:#c97a4c;--orange2:#e8a87a;--green:#4ca84c;--green2:#7ae87a;--text:#d4c9b8;--text2:#8a9ab0;--text3:#4a5a6a}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 15% 10%,rgba(201,168,76,.05) 0%,transparent 45%),radial-gradient(ellipse at 85% 85%,rgba(76,126,201,.04) 0%,transparent 45%);pointer-events:none;z-index:0}
header{position:relative;z-index:10;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(201,168,76,.06) 0%,transparent 100%)}
.hdr{max-width:1500px;margin:0 auto;padding:18px 40px 14px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.logo h1{font-family:'Cinzel Decorative',serif;font-size:18px;color:var(--gold);letter-spacing:.04em;text-shadow:0 0 24px rgba(201,168,76,.35)}
.logo p{font-family:'Cinzel',serif;font-size:9px;color:var(--text3);letter-spacing:.2em;text-transform:uppercase;margin-top:3px}
.mission-box{display:flex;align-items:center;gap:14px;background:var(--bg3);border:1px solid var(--border2);border-radius:12px;padding:10px 18px}
.mdp .n{font-family:'Cinzel Decorative',serif;font-size:30px;font-weight:900;color:var(--gold2);text-shadow:0 0 20px rgba(232,201,122,.5);line-height:1}
.mdp .l{font-family:'Cinzel',serif;font-size:8px;color:var(--text3);letter-spacing:.2em;text-transform:uppercase;margin-top:2px}
.mdiv{width:1px;height:32px;background:var(--border2)}
.minfo{font-family:'Cinzel',serif;font-size:8px;color:var(--text3);letter-spacing:.1em;text-transform:uppercase}
.minfo span{display:block;font-size:13px;color:var(--text2);margin-top:2px;letter-spacing:0;font-family:'Crimson Pro',serif;font-style:italic}
.clear-btn{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:'Cinzel',serif;font-size:8px;letter-spacing:.12em;text-transform:uppercase;padding:7px 12px;border-radius:7px;cursor:pointer;transition:all .2s}
.clear-btn:hover{border-color:var(--red);color:var(--red2)}
.auth-btn{background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:'Cinzel',serif;font-size:8px;letter-spacing:.12em;text-transform:uppercase;padding:7px 12px;border-radius:7px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px}
.auth-btn:hover{border-color:var(--gold);color:var(--gold)}
.auth-btn.logged{border-color:rgba(76,168,76,.5);color:var(--green2)}
.auth-btn.logged:hover{border-color:var(--red);color:var(--red2)}
.login-ov{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300;display:none;align-items:center;justify-content:center}
.login-ov.open{display:flex}
.login-box{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:32px 36px;width:100%;max-width:380px;text-align:center}
.login-box h2{font-family:'Cinzel Decorative',serif;font-size:15px;color:var(--gold2);margin-bottom:6px}
.login-box p{font-size:13px;color:var(--text3);margin-bottom:24px;font-style:italic}
.login-box input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'Crimson Pro',serif;font-size:15px;outline:none;margin-bottom:10px;transition:border-color .2s}
.login-box input:focus{border-color:var(--gold)}
.login-err{color:var(--red2);font-size:12px;margin-bottom:10px;min-height:18px}
.login-submit{width:100%;background:rgba(201,168,76,.15);border:1px solid var(--gold);color:var(--gold2);font-family:'Cinzel',serif;font-size:10px;letter-spacing:.12em;text-transform:uppercase;padding:11px;border-radius:8px;cursor:pointer;transition:all .2s;margin-top:4px}
.login-submit:hover{background:rgba(201,168,76,.28)}
.login-cancel{background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;margin-top:12px;font-family:'Cinzel',serif;letter-spacing:.1em;text-transform:uppercase;transition:color .2s;display:block;width:100%}
.login-cancel:hover{color:var(--text2)}
.tabs-wrap{position:relative;z-index:10;max-width:1500px;margin:0 auto;padding:18px 40px 0}
.tabs{display:flex;gap:3px;border-bottom:1px solid var(--border);align-items:flex-end;overflow-x:auto}
.tab-btn{font-family:'Cinzel',serif;font-size:11px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;padding:10px 18px;background:transparent;border:1px solid transparent;border-bottom:none;color:var(--text3);cursor:pointer;transition:all .2s;border-radius:8px 8px 0 0;position:relative;bottom:-1px;white-space:nowrap;flex-shrink:0}
.tab-btn:hover{color:var(--text2)}
.tab-btn.active{color:var(--gold2);background:var(--bg2);border-color:var(--border);border-bottom-color:var(--bg2)}
.tab-btn .cnt{display:inline-block;background:var(--bg4);border:1px solid var(--border);border-radius:10px;font-size:9px;padding:1px 5px;margin-left:5px;color:var(--text3)}
.tab-actions{display:flex;gap:8px;margin-left:auto;padding-bottom:6px;flex-shrink:0}
.tbtn{font-family:'Cinzel',serif;font-size:9px;letter-spacing:.1em;text-transform:uppercase;padding:7px 14px;border-radius:7px;cursor:pointer;transition:all .2s;white-space:nowrap}
.tbtn-camp{background:transparent;border:1px solid var(--border2);color:var(--text2)}
.tbtn-camp:hover{border-color:var(--gold);color:var(--gold)}
.tbtn-npc{background:rgba(201,168,76,.12);border:1px solid var(--gold);color:var(--gold2)}
.tbtn-npc:hover{background:rgba(201,168,76,.25)}
.main{position:relative;z-index:10;max-width:1500px;margin:0 auto;padding:20px 40px 130px}
.tab-panel{display:none}
.tab-panel.active{display:block}
.camp-title-row{display:flex;align-items:center;gap:10px;margin-bottom:18px}
.camp-title{font-family:'Cinzel',serif;font-size:16px;font-weight:700;color:var(--gold3);letter-spacing:.06em}
.edit-cn-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;padding:2px 5px;border-radius:5px;transition:color .2s}
.edit-cn-btn:hover{color:var(--gold)}
.camp-name-input{font-family:'Cinzel',serif;font-size:16px;font-weight:700;color:var(--gold3);background:transparent;border:none;border-bottom:2px solid var(--gold);outline:none;letter-spacing:.06em;width:320px}
.filters{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.filter-lbl{font-family:'Cinzel',serif;font-size:9px;letter-spacing:.18em;text-transform:uppercase;color:var(--text3);white-space:nowrap}
.faction-btns{display:flex;gap:5px;flex-wrap:wrap}
.fbtn{font-family:'Crimson Pro',serif;font-size:13px;font-weight:600;padding:4px 12px;border-radius:18px;border:1px solid var(--border2);background:transparent;color:var(--text2);cursor:pointer;transition:all .2s;white-space:nowrap}
.fbtn:hover{border-color:var(--gold);color:var(--gold)}
.fbtn.active{background:rgba(201,168,76,.1);border-color:var(--gold);color:var(--gold2)}
.search{margin-left:auto;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:7px 13px;color:var(--text);font-family:'Crimson Pro',serif;font-size:14px;width:200px;outline:none;transition:border-color .2s}
.search:focus{border-color:var(--gold)}
.search::placeholder{color:var(--text3)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:12px}
.empty-grid{grid-column:1/-1;text-align:center;padding:60px;color:var(--text3);font-style:italic}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:13px;overflow:hidden;cursor:pointer;transition:transform .2s,border-color .2s,box-shadow .2s;position:relative}
.card:hover{transform:translateY(-2px);border-color:var(--border2);box-shadow:0 6px 28px rgba(0,0,0,.4)}
.card.selected{border-color:var(--gold);box-shadow:0 0 0 1px var(--gold),0 6px 28px rgba(201,168,76,.18)}
.card.selected::after{content:'‚úì';position:absolute;top:9px;right:9px;width:20px;height:20px;background:var(--gold);color:#080b0f;border-radius:50%;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;z-index:5;line-height:20px;text-align:center}
.cedit{position:absolute;top:9px;right:34px;background:rgba(8,11,15,.7);border:none;color:var(--text3);cursor:pointer;font-size:12px;z-index:5;transition:color .2s;padding:2px 4px;border-radius:5px}
.cedit:hover{color:var(--gold)}
.card.selected .cedit{right:36px}
.card-head{padding:12px 13px 10px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:9px}
.ava{width:46px;height:46px;border-radius:9px;background:var(--bg4);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;overflow:hidden}
.ava img{width:100%;height:100%;object-fit:cover}
.name-area{flex:1;min-width:0}
.npc-name{font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:var(--gold3);line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.npc-class{font-size:11px;color:var(--text2);margin-top:1px;font-style:italic}
.npc-faction{display:inline-block;font-family:'Cinzel',serif;font-size:8px;letter-spacing:.1em;text-transform:uppercase;padding:2px 6px;border-radius:8px;margin-top:4px;border:1px solid}
.npc-rol{display:inline-block;font-family:'Cinzel',serif;font-size:8px;letter-spacing:.1em;text-transform:uppercase;padding:2px 6px;border-radius:8px;margin-top:3px;margin-left:4px;border:1px solid rgba(232,201,122,.3);background:rgba(201,168,76,.06);color:var(--gold2)}
.dp-badge{min-width:44px;height:44px;border-radius:9px;border:1px solid;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0}
.dp-badge .n{font-family:'Cinzel Decorative',serif;font-size:15px;font-weight:900;line-height:1}
.dp-badge .u{font-family:'Cinzel',serif;font-size:7px;letter-spacing:.1em;margin-top:1px}
.dp-lo{background:rgba(76,168,76,.08);border-color:#4ca84c;color:#7ae87a}
.dp-md{background:rgba(201,168,76,.08);border-color:var(--gold);color:var(--gold2)}
.dp-hi{background:rgba(201,76,76,.08);border-color:var(--red);color:var(--red2)}
.dp-pend{background:rgba(74,90,106,.15);border-color:var(--border2);color:var(--text3)}
.card-body{padding:10px 13px}
.tags{display:flex;flex-wrap:wrap;gap:4px;min-height:22px}
.tag{font-size:10px;padding:2px 7px;border-radius:9px;border:1px solid var(--border);color:var(--text2);background:var(--bg3);white-space:nowrap}
.tag.sp{border-color:var(--purple);color:var(--purple2);background:rgba(138,76,201,.06)}
.tag.wp{border-color:var(--red);color:var(--red2);background:rgba(201,76,76,.06)}
.tag.wa{border-color:var(--orange);color:var(--orange2);background:rgba(201,122,76,.06)}
.tag.ep{border-color:var(--blue);color:var(--blue2);background:rgba(76,126,201,.06)}
.tag.my{border-color:var(--gold);color:var(--gold2);background:rgba(201,168,76,.06)}
.tag.gr{border-color:var(--teal);color:var(--teal2);background:rgba(76,168,160,.06)}
.tag.cg{border-color:#a08060;color:#c8a880;background:rgba(160,128,96,.06)}
.tag.pend{border-color:var(--border2);color:var(--text3);font-style:italic}
.bd-toggle{width:100%;background:transparent;border:none;border-top:1px solid var(--border);padding:7px 13px;color:var(--text3);font-family:'Cinzel',serif;font-size:9px;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:color .2s}
.bd-toggle:hover{color:var(--gold)}
.bd-toggle .arr{transition:transform .2s;display:inline-block}
.bd-toggle.open .arr{transform:rotate(180deg)}
.breakdown{display:none;padding:9px 13px 12px;border-top:1px solid var(--border);background:rgba(0,0,0,.25)}
.breakdown.open{display:block}
.brow{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:11px;color:var(--text2);border-bottom:1px solid rgba(35,47,64,.5)}
.brow:last-child{border-bottom:none}
.brow .bv{font-weight:600;color:var(--gold);font-family:'Cinzel',serif;font-size:11px}
.n20-link{display:inline-flex;align-items:center;gap:5px;margin-top:8px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--blue2);text-decoration:none;padding:4px 10px;border:1px solid rgba(76,126,201,.3);border-radius:6px;transition:all .2s}
.n20-link:hover{background:rgba(76,126,201,.1);border-color:var(--blue2)}
.sel-panel{position:fixed;bottom:0;left:0;right:0;padding:16px 40px 22px;z-index:100;display:none;background:linear-gradient(180deg,transparent 0%,rgba(8,11,15,.98) 12px)}
.sel-panel.vis{display:block}
.sel-inner{max-width:1500px;margin:0 auto;background:var(--bg3);border:1px solid var(--border2);border-radius:13px;padding:12px 18px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;box-shadow:0 -8px 40px rgba(0,0,0,.7)}
.sel-lbl{font-family:'Cinzel',serif;font-size:9px;letter-spacing:.18em;text-transform:uppercase;color:var(--text3);white-space:nowrap}
.sel-chips{display:flex;gap:6px;flex-wrap:wrap;flex:1}
.chip{display:flex;align-items:center;gap:5px;background:var(--bg4);border:1px solid var(--border2);border-radius:18px;padding:4px 10px 4px 9px;font-size:13px}
.chip-dp{font-family:'Cinzel',serif;font-size:9px;font-weight:600;color:var(--gold);background:rgba(201,168,76,.1);border-radius:9px;padding:1px 5px}
.chip-x{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;line-height:1;padding:0;margin-left:1px;transition:color .2s}
.chip-x:hover{color:var(--red2)}
.total-dp{display:flex;align-items:baseline;gap:5px;margin-left:auto;white-space:nowrap}
.total-dp .n{font-family:'Cinzel Decorative',serif;font-size:28px;font-weight:900;color:var(--gold2);text-shadow:0 0 18px rgba(232,201,122,.4)}
.total-dp .u{font-family:'Cinzel',serif;font-size:10px;color:var(--text3);letter-spacing:.1em}
/* faction colors */
.f-sf{color:#7ab0e8;border-color:rgba(76,126,201,.45);background:rgba(76,126,201,.08)}
.f-vt{color:var(--purple2);border-color:rgba(138,76,201,.45);background:rgba(138,76,201,.08)}
.f-mc{color:var(--orange2);border-color:rgba(201,122,76,.45);background:rgba(201,122,76,.08)}
.f-xi{color:#e87a4c;border-color:rgba(201,76,46,.45);background:rgba(201,76,46,.08)}
.f-est{color:var(--gold2);border-color:rgba(201,168,76,.45);background:rgba(201,168,76,.08)}
.f-rep{color:var(--teal2);border-color:rgba(76,168,160,.45);background:rgba(76,168,160,.08)}
.f-hd{color:var(--green2);border-color:rgba(76,168,76,.45);background:rgba(76,168,76,.08)}
.f-sig{color:#c8a880;border-color:rgba(160,128,96,.45);background:rgba(160,128,96,.08)}
.f-nav{color:#a0c8e8;border-color:rgba(100,168,220,.45);background:rgba(100,168,220,.08)}
.f-nom{color:#c8c880;border-color:rgba(168,168,96,.45);background:rgba(168,168,96,.08)}
.f-tri{color:var(--red2);border-color:rgba(201,76,76,.45);background:rgba(201,76,76,.08)}
.f-def{color:var(--text2);border-color:var(--border2);background:var(--bg4)}
/* Terror of Tecnovore factions */
.f-tt {color:#f0a0a0;border-color:rgba(220,80,80,.45);background:rgba(220,80,80,.08)}
.f-ch {color:#a0d0f0;border-color:rgba(60,140,200,.45);background:rgba(60,140,200,.08)}
.f-trb{color:#a0f0a0;border-color:rgba(60,200,60,.45);background:rgba(60,200,60,.08)}
.f-mec{color:#c0c0d0;border-color:rgba(140,140,180,.45);background:rgba(140,140,180,.08)}
.f-rf {color:#a0e0ff;border-color:rgba(60,180,240,.45);background:rgba(60,180,240,.08)}
.f-cen{color:#d0c0a0;border-color:rgba(180,150,80,.45);background:rgba(180,150,80,.08)}
.f-sab{color:#f0d080;border-color:rgba(210,170,40,.45);background:rgba(210,170,40,.08)}
.f-bri{color:#e0a0c0;border-color:rgba(200,80,120,.45);background:rgba(200,80,120,.08)}
.f-ri {color:#90e0b0;border-color:rgba(60,180,120,.45);background:rgba(60,180,120,.08)}
.f-abt{color:#d0a080;border-color:rgba(180,120,60,.45);background:rgba(180,120,60,.08)}
.f-oe {color:#f0c080;border-color:rgba(210,150,40,.45);background:rgba(210,150,40,.08)}
.f-ir {color:#e0c0a0;border-color:rgba(190,150,90,.45);background:rgba(190,150,90,.08)}
.f-dev{color:#d0a0f0;border-color:rgba(170,80,220,.45);background:rgba(170,80,220,.08)}
/* MODAL */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-ov.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto;position:relative}
.modal-hdr{padding:20px 26px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg2);z-index:2}
.modal-hdr h2{font-family:'Cinzel',serif;font-size:14px;font-weight:700;color:var(--gold3);letter-spacing:.06em}
.mcl{background:none;border:none;color:var(--text3);cursor:pointer;font-size:22px;line-height:1;padding:2px;transition:color .2s}
.mcl:hover{color:var(--red2)}
.mbody{padding:20px 26px 24px}
.fsec{margin-bottom:18px}
.fsec-t{font-family:'Cinzel',serif;font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(--gold);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.frow.full{grid-template-columns:1fr}
.fg{display:flex;flex-direction:column;gap:4px}
.fg label{font-family:'Cinzel',serif;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)}
.fg input[type=text],.fg input[type=number],.fg select,.fg textarea{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:7px 11px;color:var(--text);font-family:'Crimson Pro',serif;font-size:14px;outline:none;transition:border-color .2s;width:100%}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--gold)}
.fg select option{background:var(--bg3)}
.img-area{border:2px dashed var(--border2);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:border-color .2s;position:relative}
.img-area:hover{border-color:var(--gold)}
.img-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.img-prev{width:72px;height:72px;border-radius:10px;object-fit:cover;margin:0 auto 8px;display:block}
.img-txt{font-size:11px;color:var(--text3);font-style:italic}
.cr{display:flex;align-items:center;gap:9px;padding:6px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;margin-bottom:5px;transition:border-color .2s}
.cr:hover{border-color:var(--border2)}
.cr.active{border-color:rgba(201,168,76,.35);background:rgba(201,168,76,.04)}
.cr input[type=checkbox]{width:14px;height:14px;accent-color:var(--gold);cursor:pointer;flex-shrink:0}
.cr label{font-size:13px;color:var(--text2);cursor:pointer;flex:1;line-height:1.3}
.cr .dph{font-family:'Cinzel',serif;font-size:9px;color:var(--text3);white-space:nowrap;flex-shrink:0}
.cnum{width:56px!important;padding:4px 7px!important;font-size:13px!important;text-align:center!important;flex-shrink:0}
.cnum:disabled{opacity:.3}
.sub-list{padding:5px 0 2px 22px;display:none;flex-direction:column;gap:4px}
.sub-list.show{display:flex}
.sr{display:flex;align-items:center;gap:8px;padding:5px 9px;background:rgba(0,0,0,.18);border:1px solid var(--border);border-radius:7px}
.sr input[type=checkbox]{width:13px;height:13px;accent-color:var(--gold);cursor:pointer}
.sr label{font-size:12px;color:var(--text2);cursor:pointer;flex:1}
.sr .dph{font-family:'Cinzel',serif;font-size:9px;color:var(--text3)}
.modal-ftr{padding:14px 26px 18px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:9px;position:sticky;bottom:0;background:var(--bg2)}
.btn-del{background:rgba(201,76,76,.1);border:1px solid var(--red);color:var(--red2);font-family:'Cinzel',serif;font-size:9px;letter-spacing:.1em;text-transform:uppercase;padding:9px 14px;border-radius:8px;cursor:pointer;transition:all .2s;margin-right:auto}
.btn-del:hover{background:rgba(201,76,76,.25)}
.btn-can{background:transparent;border:1px solid var(--border2);color:var(--text2);font-family:'Cinzel',serif;font-size:9px;letter-spacing:.1em;text-transform:uppercase;padding:9px 16px;border-radius:8px;cursor:pointer;transition:all .2s}
.btn-can:hover{border-color:var(--red);color:var(--red2)}
.btn-sav{background:rgba(201,168,76,.15);border:1px solid var(--gold);color:var(--gold2);font-family:'Cinzel',serif;font-size:9px;letter-spacing:.1em;text-transform:uppercase;padding:9px 20px;border-radius:8px;cursor:pointer;transition:all .2s}
.btn-sav:hover{background:rgba(201,168,76,.28)}
@media(max-width:768px){.hdr,.tabs-wrap,.main{padding-left:16px;padding-right:16px}.sel-panel{padding:12px 16px 16px}.grid{grid-template-columns:1fr}.search{width:100%;margin-left:0}.frow{grid-template-columns:1fr}.mbody,.modal-hdr,.modal-ftr{padding-left:16px;padding-right:16px}}

/* ‚îÄ‚îÄ‚îÄ INVENTORY ‚îÄ‚îÄ‚îÄ */
.inv-section{margin-bottom:28px}
.inv-header{display:flex;align-items:center;gap:10px;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.inv-title{font-family:'Cinzel',serif;font-size:12px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--gold);display:flex;align-items:center;gap:7px}
.inv-count{font-family:'Cinzel',serif;font-size:9px;color:var(--text3);background:var(--bg4);border:1px solid var(--border);border-radius:9px;padding:1px 6px}
.btn-new-item{margin-left:auto;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.4);color:var(--gold2);font-family:'Cinzel',serif;font-size:9px;letter-spacing:.1em;text-transform:uppercase;padding:6px 13px;border-radius:7px;cursor:pointer;transition:all .2s}
.btn-new-item:hover{background:rgba(201,168,76,.22)}
.inv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.inv-empty{grid-column:1/-1;text-align:center;padding:28px;color:var(--text3);font-style:italic;font-size:13px;border:1px dashed var(--border);border-radius:10px}
.icard{background:var(--bg2);border:1px solid var(--border);border-radius:11px;overflow:hidden;transition:border-color .2s,transform .2s;position:relative}
.icard:hover{border-color:var(--border2);transform:translateY(-1px)}
.icard-edit{position:absolute;top:7px;right:7px;background:rgba(8,11,15,.7);border:none;color:var(--text3);cursor:pointer;font-size:11px;z-index:5;padding:2px 5px;border-radius:5px;transition:color .2s;display:none}
.icard-edit:hover{color:var(--gold)}
.icard-img{width:100%;height:110px;object-fit:cover;display:block;background:var(--bg4)}
.icard-img-placeholder{width:100%;height:110px;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:32px;color:var(--border2)}
.icard-body{padding:10px 12px 12px}
.icard-name{font-family:'Cinzel',serif;font-size:11px;font-weight:700;color:var(--gold3);margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.icard-desc{font-size:12px;color:var(--text2);font-style:italic;line-height:1.4;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.icard-qty{display:inline-flex;align-items:center;gap:5px;background:var(--bg4);border:1px solid var(--border2);border-radius:7px;padding:3px 9px}
.icard-qty .ql{font-family:'Cinzel',serif;font-size:8px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3)}
.icard-qty .qn{font-family:'Cinzel Decorative',serif;font-size:13px;font-weight:900;color:var(--gold2);line-height:1}
.qty-ctrl{display:flex;align-items:center;gap:0}
.qty-ctrl button{width:32px;height:32px;background:var(--bg4);border:1px solid var(--border);color:var(--text2);font-size:16px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.qty-ctrl button:first-child{border-radius:7px 0 0 7px}
.qty-ctrl button:last-child{border-radius:0 7px 7px 0}
.qty-ctrl button:hover{background:rgba(201,168,76,.15);border-color:var(--gold);color:var(--gold2)}
.qty-ctrl input{width:60px;height:32px;background:var(--bg3);border:1px solid var(--border);border-left:none;border-right:none;color:var(--text);font-family:'Cinzel Decorative',serif;font-size:15px;font-weight:900;text-align:center;outline:none}
</style>
</head>
<body>

<header>
  <div class="hdr">
    <div class="logo">
      <h1>Gestor de Despliegue</h1>
      <p>Sistema de Puntos de Despliegue ¬∑ NPC</p>
    </div>
    <div class="mission-box">
      <div class="mdp"><div class="n" id="hdr-dp">0</div><div class="l">DP Totales</div></div>
      <div class="mdiv"></div>
      <div class="minfo">En misi√≥n<span id="hdr-cnt">Ninguno</span></div>
      <button class="clear-btn" id="clear-btn" onclick="clearAll()">‚úï Limpiar</button>
      <button class="auth-btn" onclick="openExport()">üì• Exportar</button>
      <button class="auth-btn" id="auth-btn" onclick="authClick()">üîí Editar</button>
    </div>
  </div>
</header>

<!-- LOGIN MODAL -->
<div class="login-ov" id="loginModal">
  <div class="login-box">
    <h2>Modo Edici√≥n</h2>
    <p>Introduce tus credenciales para editar</p>
    <input type="text" id="login-user" placeholder="Usuario" autocomplete="username">
    <input type="password" id="login-pass" placeholder="Contrase√±a" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    <div class="login-err" id="login-err"></div>
    <button class="login-submit" onclick="doLogin()">Entrar</button>
    <button class="login-cancel" onclick="closeLogin()">Cancelar</button>
  </div>
</div>

<!-- EXPORT MODAL -->
<div class="login-ov" id="exportModal">
  <div class="login-box" style="max-width:440px;text-align:left">
    <h2 style="text-align:center;margin-bottom:6px">Exportar Personajes</h2>
    <p style="text-align:center;margin-bottom:20px">Elige campa√±a y formato de archivo</p>
    <div style="margin-bottom:12px">
      <label style="font-family:'Cinzel',serif;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3);display:block;margin-bottom:6px">Campa√±a</label>
      <select id="exp-camp" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'Crimson Pro',serif;font-size:14px;outline:none">
        <option value="all">Todas las campa√±as</option>
      </select>
    </div>
    <div style="margin-bottom:20px">
      <label style="font-family:'Cinzel',serif;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3);display:block;margin-bottom:6px">Formato</label>
      <div style="display:flex;gap:8px">
        <button class="login-submit" style="margin-top:0" onclick="doExport('csv')">üìÑ CSV</button>
        <button class="login-submit" style="margin-top:0;background:rgba(76,126,201,.15);border-color:var(--blue);color:var(--blue2)" onclick="doExport('xlsx')">üìä Excel</button>
      </div>
    </div>
    <button class="login-cancel" onclick="closeExport()">Cancelar</button>
  </div>
</div>

<div class="tabs-wrap">
  <div class="tabs" id="tabs-container">
    <div class="tab-actions" id="tab-actions">
      <button class="tbtn tbtn-npc" id="btn-new-npc" onclick="openNewNPC()" style="display:none">+ Nuevo Personaje</button>
      <button class="tbtn tbtn-camp" id="btn-new-camp" onclick="addCampaign()" style="display:none">+ Nueva Campa√±a</button>
    </div>
  </div>
</div>

<div class="main" id="main-panels"></div>

<div class="sel-panel" id="selPanel">
  <div class="sel-inner">
    <span class="sel-lbl">En misi√≥n:</span>
    <div class="sel-chips" id="selChips"></div>
    <div class="total-dp"><span class="n" id="totalDP">0</span><span class="u">DP</span></div>
  </div>
</div>

<!-- ITEM MODAL -->
<div class="modal-ov" id="itemModal">
  <div class="modal" style="max-width:500px">
    <div class="modal-hdr">
      <h2 id="item-modal-title">Nuevo Art√≠culo</h2>
      <button class="mcl" onclick="closeItemModal()">√ó</button>
    </div>
    <div class="mbody" id="item-modal-body">
      <div class="fsec">
        <div class="fsec-t">Informaci√≥n del Art√≠culo</div>
        <div class="frow full"><div class="fg"><label>Nombre</label><input type="text" id="if_name" placeholder="Nombre del art√≠culo"></div></div>
        <div class="frow full"><div class="fg"><label>Descripci√≥n</label><textarea id="if_desc" rows="3" placeholder="Descripci√≥n‚Ä¶" style="resize:vertical"></textarea></div></div>
        <div class="frow"><div class="fg"><label>Cantidad</label>
          <div class="qty-ctrl">
            <button type="button" onclick="itemQtyAdj(-1)">‚àí</button>
            <input type="number" id="if_qty" value="1" min="0">
            <button type="button" onclick="itemQtyAdj(1)">+</button>
          </div>
        </div></div>
        <div class="frow full"><div class="fg">
          <label>Imagen <span style="color:var(--text3);font-style:italic">(opcional)</span></label>
          <div class="img-area" id="item-img-area">
            <input type="file" accept="image/*" onchange="onItemImgUpload(this)">
            <div id="item-img-prev"></div>
            <div class="img-txt" id="item-img-txt">Clic o arrastra una imagen</div>
          </div>
        </div></div>
      </div>
    </div>
    <div class="modal-ftr">
      <button class="btn-del" id="item-btn-del" onclick="deleteItem()" style="display:none">üóë Eliminar</button>
      <button class="btn-can" onclick="closeItemModal()">Cancelar</button>
      <button class="btn-sav" onclick="saveItem()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-ov" id="npcModal">
  <div class="modal">
    <div class="modal-hdr">
      <h2 id="modal-title">Nuevo Personaje</h2>
      <button class="mcl" onclick="closeModal()">√ó</button>
    </div>
    <div class="mbody" id="modal-body"></div>
    <div class="modal-ftr">
      <button class="btn-del" id="btn-del" onclick="deleteNPC()" style="display:none">üóë Eliminar</button>
      <button class="btn-can" onclick="closeModal()">Cancelar</button>
      <button class="btn-sav" onclick="saveNPC()">Guardar</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ FACTION INFO ‚îÄ‚îÄ‚îÄ
const FI = {
  "Star Force":                   {cls:"f-sf",  emoji:"‚≠ê"},
  "Liga de los Vottan":           {cls:"f-vt",  emoji:"üîÆ"},
  "Mercenarios":                  {cls:"f-mc",  emoji:"‚öîÔ∏è"},
  "Dioses de Xibalba":            {cls:"f-xi",  emoji:"üî•"},
  "Dioses Estelares":             {cls:"f-est", emoji:"‚ú®"},
  "Rep√∫blica Interestelar":       {cls:"f-rep", emoji:"üåå"},
  "Helldivers":                   {cls:"f-hd",  emoji:"ü™ñ"},
  "Imperio de Sigmar":            {cls:"f-sig", emoji:"üèõÔ∏è"},
  "Navegantes del Valhalla":      {cls:"f-nav", emoji:"üö¢"},
  "Pasajeros N√≥madas":            {cls:"f-nom", emoji:"üß≥"},
  "Tripulaci√≥n Stultifera Navis": {cls:"f-tri", emoji:"üõ∏"},
  // TERROR OF TECNOVORE
  "Trauma Team":        {cls:"f-tt",  emoji:"üöë"},
  "Chaldea":            {cls:"f-ch",  emoji:"‚öóÔ∏è"},
  "Team Rainbow":       {cls:"f-trb", emoji:"üåà"},
  "Mechanicus":         {cls:"f-mec", emoji:"‚öôÔ∏è"},
  "Repli-Force":        {cls:"f-rf",  emoji:"ü§ñ"},
  "Centinelas":         {cls:"f-cen", emoji:"üõ°Ô∏è"},
  "Reino de Saba":      {cls:"f-sab", emoji:"üëë"},
  "Reino de Britannia": {cls:"f-bri", emoji:"‚öîÔ∏è"},
  "Rhodes Island":      {cls:"f-ri",  emoji:"üåø"},
  "Abtergo":            {cls:"f-abt", emoji:"ü¶Ö"},
  "Orient Express":     {cls:"f-oe",  emoji:"üöÇ"},
  "Imperio Romano":     {cls:"f-ir",  emoji:"üèõÔ∏è"},
  "Devas":              {cls:"f-dev", emoji:"‚ú®"},
};

// ‚îÄ‚îÄ‚îÄ CAMPAIGNS ‚îÄ‚îÄ‚îÄ
let campaigns = [
  {id:0, name:"Stultifera Navis"},
  {id:1, name:"Campa√±a 2"},
];

// ‚îÄ‚îÄ‚îÄ DP CALC ‚îÄ‚îÄ‚îÄ
function calcDP(n) {
  if (n.dpPendiente) return {dp:"?", bd:[], pend:true};
  let dp = 2;
  const bd = [{l:"Base (ficha de personaje)", v:2}];
  const add = (v,l) => { if(v>0){dp+=v;bd.push({l,v});} };

  // Tipo de ficha
  if(n.fichaNivel){
    add(1,"Ficha de Nivel");
    if(n.fichaParty){
      add(1,"Nivel de la Party");
      const ns = parseInt(n.fichaSuperior)||0;
      add(ns, `Niveles por encima de la party √ó${ns} ‚Üí +${ns} DP`);
    }
  }

  add(parseInt(n.cargos)||0, `Cargos importantes √ó${n.cargos}`);
  if(n.donEstrellas) add(2,"Don de las Estrellas");
  if(n.doteHeroico) add(1,"Dote Heroico");
  if(n.piedad) add(1,"Poseer una Piedad");
  const pant = parseInt(n.panteismo)||0;
  add(pant, `Piedad de Pante√≠smo √ó${pant} dioses`);
  add(parseInt(n.bendEpicas)||0,  `Bendiciones √âpicas √ó${n.bendEpicas||0}`);
  add(parseInt(n.bendMiticas)||0, `Bendiciones M√≠ticas √ó${n.bendMiticas||0}`);
  add(parseInt(n.conjMiticos)||0, `Conjuros M√≠ticos √ó${n.conjMiticos||0}`);
  add(parseInt(n.maniMiticas)||0, `Maniobras M√≠ticas √ó${n.maniMiticas||0}`);
  if((parseInt(n.entrAtrib)||0)>=2)  add(1,`Entrenam. Atributos √ó${n.entrAtrib}`);
  if((parseInt(n.entrSalv)||0)>=2)   add(1,`Entrenam. Salvaciones √ó${n.entrSalv}`);
  if((parseInt(n.dotesEntr)||0)>=2)  add(1,`Dotes Entrenados √ó${n.dotesEntr}`);
  const rb = Math.floor((parseInt(n.rasgosEntr)||0)/2);
  add(rb, `Rasgos Especiales √ó${n.rasgosEntr||0} ‚Üí +${rb} DP`);
  if(n.equipCompleto) add(1,"Equipamiento Completo");
  if(n.armMuyRara) add(2,"Armadura Muy Rara");
  if(n.escMuyRaro) add(2,"Escudo Muy Raro");
  if(n.servoMuyRara) add(1,"Servo-Armadura (Muy Rara)");
  if(n.armLegendaria) add(4,"Armadura Legendaria");
  if(n.escLegendario) add(4,"Escudo Legendario");
  if(n.servoLegendaria) add(2,"Servo-Armadura (Legendaria)");
  if(n.armtoMuyRaro){ add(2,"Armamento Muy Raro"); if(n.armtoMuyRaroMas2) add(1,"Armamento Muy Raro (>2 piezas)"); }
  if(n.armtoLegendario){ add(4,"Armamento Legendario"); if(n.armtoLegendarioMas2) add(2,"Armamento Legendario (>2 piezas)"); }
  const ap = parseInt(n.altoPoder)||0;
  add(ap*3, `Armamento Alto Poder √ó${ap} ‚Üí +${ap*3} DP`);
  add(parseInt(n.consumibles)||0, `Consumibles Alto Poder √ó${n.consumibles||0} tipos`);
  // Tesoro divino/legendario √ó5
  const td = parseInt(n.tesoroDivino)||0;
  add(td*5, `Tesoro Divino/Legendario √ó${td} ‚Üí +${td*5} DP`);
  // Cartas del mazo
  const cm = parseInt(n.cartasMazo)||0;
  add(cm, `Cartas Mazo (atributos) √ó${cm}`);
  // Carta La Estrella √ó3 por cada vez
  const ce = parseInt(n.cartaEstrella)||0;
  add(ce*3, `Carta La Estrella √ó${ce} ‚Üí +${ce*3} DP`);
  // Carta El √Årbol +4
  if(n.cartaArbol) add(4,"Carta: El √Årbol");
  add(parseInt(n.objAtrib)||0, `Objetos/Modif. de atributos √ó${n.objAtrib||0}`);
  // Transformaci√≥n sobrenatural √ó2
  const ts = parseInt(n.transformacion)||0;
  add(ts*2, `Transformaci√≥n Sobrenatural √ó${ts} ‚Üí +${ts*2} DP`);
  if(n.avatar){
    add(3,"Avatar de Divinidad");
    const rp = parseInt(n.rupturas)||0;
    add(rp*2, `Rupturas del L√≠mite √ó${rp} ‚Üí +${rp*2} DP`);
  }
  if(n.setPrimordial) add(4,"Set Primordial Completo");
  // Familiares en combate
  if(n.familiares){ add(2,"Familiares en Combate"); if(n.familiaresAltoPoder) add(4,"Familiares de Alto Poder"); }
  // Clase adicional +3 base + (n√∫mero √ó 2)
  if(n.claseAdicional){
    add(3,"Clase Adicional");
    const ca = parseInt(n.clasesExtra)||0;
    add(ca*2, `Clases Extra √ó${ca} ‚Üí +${ca*2} DP`);
  }
  // Carta La Lanza +3 + subcasilla honor y cordura +1
  if(n.cartaLanza){ add(3,"Carta: La Lanza"); if(n.cartaLanzaHonor) add(1,"La Lanza: Honor y Cordura"); }
  // Subclase Adicional √ó2 DP c/u (m√≠n 1)
  if(n.subclaseAdicional){
    const sc = Math.max(1, parseInt(n.subclasesExtra)||1);
    add(sc*2, `Subclase Adicional √ó${sc} ‚Üí +${sc*2} DP`);
  }
  // Naturaleza Legendaria +3 + dotes legendarios √ó2
  if(n.naturalezaLegendaria){
    add(3,"Naturaleza Legendaria");
    const dl = parseInt(n.dotesLegendarios)||0;
    add(dl*2, `Dotes Legendarios √ó${dl} ‚Üí +${dl*2} DP`);
  }
  return {dp, bd, pend:false};
}
function dpCls(dp){ if(dp==="?") return "dp-pend"; if(dp<=4) return "dp-lo"; if(dp<=8) return "dp-md"; return "dp-hi"; }

// ‚îÄ‚îÄ‚îÄ NPCs ‚îÄ‚îÄ‚îÄ
let NPCS = [
  // STAR FORCE
  {id:"majestic-red",camp:0,emoji:"üõ°Ô∏è",name:"Majestic Red",cls:"Guerrero ¬∑ Nivel 19",faction:"Star Force",url:"https://nivel20.com/games/dnd-5/campaigns/45678-stultifera-navis/creatures/263328-majestic-red",img:"",dpPendiente:false,cargos:1,donEstrellas:false,armaArca:true,armaArcaDespertada:true,doteHeroico:true,piedad:false,panteismo:0,bendEpicas:1,bendMiticas:0,conjMiticos:0,maniMiticas:2,entrAtrib:3,entrSalv:2,dotesEntr:3,rasgosEntr:4,equipCompleto:true,armMuyRara:false,escMuyRaro:false,servoMuyRara:false,armLegendaria:true,escLegendario:false,servoLegendaria:false,armtoMuyRaro:false,armtoMuyRaroMas2:false,armtoLegendario:true,armtoLegendarioMas2:false,altoPoder:0,consumibles:0,cartasMazo:0,cartaEstrella:false,objAtrib:0,avatar:false,rupturas:0,setPrimordial:false},
  {id:"subaru",camp:0,emoji:"‚ö°",name:"Subaru Hoshikawa",cls:"Guerrero Psi√≥nico ¬∑ Nivel 19",faction:"Star Force",url:"https://nivel20.com/s/19x03zczc",img:"",dpPendiente:true},
  // LIGA DE LOS VOTTAN
  {id:"natalia",camp:0,emoji:"‚öóÔ∏è",name:"Natalia Alekseeva",cls:"Art√≠fice ¬∑ Nivel 19",faction:"Liga de los Vottan",url:"https://nivel20.com/s/12cf5zczc",img:"",dpPendiente:true},
  // MERCENARIOS
  {id:"acolmiztli",camp:0,emoji:"ü¶Å",name:"Acolmiztli",cls:"‚Äî",faction:"Mercenarios",url:"https://nivel20.com/s/124lmzczc",img:"",dpPendiente:true},
  {id:"marcus",camp:0,emoji:"üó°Ô∏è",name:"Marcus Aquilus",cls:"‚Äî",faction:"Mercenarios",url:"https://nivel20.com/s/ulrpzczc",img:"",dpPendiente:true},
  {id:"ingrid",camp:0,emoji:"ü™ì",name:"Ingrid Skjoldr",cls:"‚Äî",faction:"Mercenarios",url:"https://nivel20.com/s/jvhizczc",img:"",dpPendiente:true},
  {id:"elena",camp:0,emoji:"üåø",name:"Elena Navarro",cls:"‚Äî",faction:"Mercenarios",url:"https://nivel20.com/s/uls0zczc",img:"",dpPendiente:true},
  {id:"freya-f",camp:0,emoji:"‚ùÑÔ∏è",name:"Freya Frostveil",cls:"‚Äî",faction:"Mercenarios",url:"https://nivel20.com/s/jwb4zczc",img:"",dpPendiente:true},
  {id:"sora",camp:0,emoji:"üåä",name:"Sora Nakamura",cls:"‚Äî",faction:"Mercenarios",url:"https://nivel20.com/s/jvirzczc",img:"",dpPendiente:true},
  {id:"isabella",camp:0,emoji:"üå∏",name:"Isabella Garc√≠a",cls:"‚Äî",faction:"Mercenarios",url:"https://nivel20.com/s/umx6zczc",img:"",dpPendiente:true},
  {id:"into-abyss",camp:0,emoji:"üï≥Ô∏è",name:"Into the Abyss",cls:"‚Äî",faction:"Mercenarios",url:"https://nivel20.com/s/x43tzczc",img:"",dpPendiente:true},
  // DIOSES DE XIBALBA
  {id:"tlaloc",camp:0,emoji:"üåßÔ∏è",name:"Tl√°loc",cls:"‚Äî",faction:"Dioses de Xibalba",url:"https://nivel20.com/s/12bfizczc",img:"",dpPendiente:true},
  {id:"xi2",camp:0,emoji:"üíÄ",name:"‚Äî (Xibalba 2)",cls:"‚Äî (link privado)",faction:"Dioses de Xibalba",url:"https://nivel20.com/s/wk6fzczc",img:"",dpPendiente:true},
  {id:"xi3",camp:0,emoji:"üî•",name:"‚Äî (Xibalba 3)",cls:"‚Äî (link privado)",faction:"Dioses de Xibalba",url:"https://nivel20.com/s/wls3zczc",img:"",dpPendiente:true},
  // DIOSES ESTELARES
  {id:"ishtar",camp:0,emoji:"‚≠ê",name:"Ishtar",cls:"‚Äî",faction:"Dioses Estelares",url:"https://nivel20.com/s/w3xtzczc",img:"",dpPendiente:true},
  {id:"poseidon",camp:0,emoji:"üî±",name:"Poseid√≥n",cls:"‚Äî",faction:"Dioses Estelares",url:"https://nivel20.com/s/w36ozczc",img:"",dpPendiente:true},
  // REP√öBLICA INTERESTELAR
  {id:"leonhard",camp:0,emoji:"üß™",name:"Leonhard von Braun",cls:"‚Äî",faction:"Rep√∫blica Interestelar",url:"https://nivel20.com/s/lycjzczc",img:"",dpPendiente:true},
  {id:"emily",camp:0,emoji:"‚ö°",name:"Emily Tesla",cls:"‚Äî",faction:"Rep√∫blica Interestelar",url:"https://nivel20.com/s/vbyrzczc",img:"",dpPendiente:true},
  {id:"julius",camp:0,emoji:"üí°",name:"Julius Edison",cls:"‚Äî",faction:"Rep√∫blica Interestelar",url:"https://nivel20.com/s/jprmzczc",img:"",dpPendiente:true},
  // HELLDIVERS
  {id:"esmeralda",camp:0,emoji:"ü™ñ",name:"Esmeralda Cisneros",cls:"‚Äî",faction:"Helldivers",url:"https://nivel20.com/s/sj26zczc",img:"",dpPendiente:true},
  {id:"samanta",camp:0,emoji:"üí•",name:"Samanta Noriega",cls:"‚Äî",faction:"Helldivers",url:"https://nivel20.com/s/sj22zczc",img:"",dpPendiente:true},
  {id:"bruno",camp:0,emoji:"üî´",name:"Bruno Mart√≠nez",cls:"‚Äî",faction:"Helldivers",url:"https://nivel20.com/s/11topzczc",img:"",dpPendiente:true},
  {id:"miguel-x",camp:0,emoji:"‚öîÔ∏è",name:"Miguel Xabat, el Aniquilador",cls:"‚Äî",faction:"Helldivers",url:"https://nivel20.com/s/10gp1zczc",img:"",dpPendiente:true},
  {id:"selene-x",camp:0,emoji:"üåô",name:"Selene Xabat, la Ins√≥lita",cls:"‚Äî",faction:"Helldivers",url:"https://nivel20.com/s/1178gzczc",img:"",dpPendiente:true},
  {id:"lucia-x",camp:0,emoji:"üõ°Ô∏è",name:"Luc√≠a Xabat, la Inamovible",cls:"‚Äî",faction:"Helldivers",url:"https://nivel20.com/s/117gtzczc",img:"",dpPendiente:true},
  {id:"isabel-x",camp:0,emoji:"üí®",name:"Isabel Xabat, la Inalcanzable",cls:"‚Äî",faction:"Helldivers",url:"https://nivel20.com/s/117d0zczc",img:"",dpPendiente:true},
  // IMPERIO DE SIGMAR
  {id:"anacoreta",camp:0,emoji:"üìø",name:"Anacoreta",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/wjgkzczc",img:"",dpPendiente:true},
  {id:"neoth",camp:0,emoji:"üëë",name:"Neoth (Emperador de la Humanidad)",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/wdouzczc",img:"",dpPendiente:true},
  {id:"marina",camp:0,emoji:"üî¨",name:"Marina Curie",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/wdqezczc",img:"",dpPendiente:true},
  {id:"khuree",camp:0,emoji:"üèπ",name:"Khuree Zoriktogtokh",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/wdjkzczc",img:"",dpPendiente:true},
  {id:"mikhail",camp:0,emoji:"üß†",name:"Mikhail Xavier",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/wdj6zczc",img:"",dpPendiente:true},
  {id:"dakari",camp:0,emoji:"‚ö°",name:"Dakari Jorun",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/uys7zczc",img:"",dpPendiente:true},
  {id:"quintus",camp:0,emoji:"‚öñÔ∏è",name:"Quintus Valerius",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/w9s3zczc",img:"",dpPendiente:true},
  {id:"dimitrius",camp:0,emoji:"‚òÄÔ∏è",name:"Dimitrius Lucis",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/xl4gzczc",img:"",dpPendiente:true},
  {id:"garviel",camp:0,emoji:"üè∞",name:"Garviel Castellan",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/wdhyzczc",img:"",dpPendiente:true},
  {id:"arcadio",camp:0,emoji:"üìñ",name:"Arcadio Albus",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/uyu5zczc",img:"",dpPendiente:true},
  {id:"kael",camp:0,emoji:"üå´Ô∏è",name:"Kael Haze",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/v68kzczc",img:"",dpPendiente:true},
  {id:"caleus",camp:0,emoji:"üåø",name:"Caleus",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/m0d8zczc",img:"",dpPendiente:true},
  {id:"isolde",camp:0,emoji:"üåπ",name:"Isolde Valeria",cls:"‚Äî",faction:"Imperio de Sigmar",url:"https://nivel20.com/s/19yqezczc",img:"",dpPendiente:true},
  // NAVEGANTES DEL VALHALLA
  {id:"lunaria",camp:0,emoji:"üåô",name:"Lunaria",cls:"‚Äî",faction:"Navegantes del Valhalla",url:"https://nivel20.com/s/we8rzczc",img:"",dpPendiente:true},
  {id:"arlan",camp:0,emoji:"‚öì",name:"Arlan",cls:"‚Äî",faction:"Navegantes del Valhalla",url:"https://nivel20.com/s/t5shzczc",img:"",dpPendiente:true},
  {id:"gale",camp:0,emoji:"üå¨Ô∏è",name:"Gale",cls:"‚Äî",faction:"Navegantes del Valhalla",url:"https://nivel20.com/s/we0rzczc",img:"",dpPendiente:true},
  {id:"ragnar",camp:0,emoji:"ü™ì",name:"Ragnar",cls:"‚Äî",faction:"Navegantes del Valhalla",url:"https://nivel20.com/s/18akczczc",img:"",dpPendiente:true},
  // PASAJEROS N√ìMADAS
  {id:"suu",camp:0,emoji:"üå∫",name:"Suu",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/yx2yzczc",img:"",dpPendiente:true},
  {id:"miel",camp:0,emoji:"üçØ",name:"Miel",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/r30yzczc",img:"",dpPendiente:true},
  {id:"julian",camp:0,emoji:"üéØ",name:"Julian",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/r0ymzczc",img:"",dpPendiente:true},
  {id:"aarav",camp:0,emoji:"üï∑Ô∏è",name:"Aarav, la Aranara",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/r1mszczc",img:"",dpPendiente:true},
  {id:"aaron",camp:0,emoji:"üî©",name:"Aaron Roberts",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/r1khzczc",img:"",dpPendiente:true},
  {id:"anker",camp:0,emoji:"‚öì",name:"Anker",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/shwuzczc",img:"",dpPendiente:true},
  {id:"marius-b",camp:0,emoji:"üß≤",name:"Marius Brackman",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/16w0nzczc",img:"",dpPendiente:true},
  {id:"titanoclad",camp:0,emoji:"ü§ñ",name:"Titanoclad",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/x4wuzczc",img:"",dpPendiente:true},
  {id:"setaru",camp:0,emoji:"‚ôæÔ∏è",name:"Setaru Gojo",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/12nqizczc",img:"",dpPendiente:true},
  {id:"orianna",camp:0,emoji:"üé∂",name:"Orianna √Åxander",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/12ugezczc",img:"",dpPendiente:true},
  {id:"luis-m",camp:0,emoji:"üó°Ô∏è",name:"Luis Montenegro",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/lqr2zczc",img:"",dpPendiente:true},
  {id:"freya-c",camp:0,emoji:"üåø",name:"Freya Casey",cls:"‚Äî",faction:"Pasajeros N√≥madas",url:"https://nivel20.com/s/xnw9zczc",img:"",dpPendiente:true},
  // TRIPULACI√ìN
  {id:"johanna",camp:0,emoji:"üåä",name:"Johanna Alcala",cls:"‚Äî",faction:"Tripulaci√≥n Stultifera Navis",url:"https://nivel20.com/s/x7vyzczc",img:"",dpPendiente:true},
  {id:"conrad",camp:0,emoji:"‚öôÔ∏è",name:"Conrad Alcala",cls:"‚Äî",faction:"Tripulaci√≥n Stultifera Navis",url:"https://nivel20.com/s/1359bzczc",img:"",dpPendiente:true},
  {id:"mon3tr",camp:0,emoji:"ü§ñ",name:"Mon3tr",cls:"‚Äî",faction:"Tripulaci√≥n Stultifera Navis",url:"https://nivel20.com/s/12nk9zczc",img:"",dpPendiente:true},
  {id:"sol-rojo",camp:0,emoji:"‚òÄÔ∏è",name:"Maquinaria Valerosa: Sol Rojo",cls:"‚Äî",faction:"Tripulaci√≥n Stultifera Navis",url:"https://nivel20.com/s/12ni8zczc",img:"",dpPendiente:true},
  {id:"cepheus",camp:0,emoji:"üöÄ",name:"Cepheus Kirk",cls:"‚Äî",faction:"Tripulaci√≥n Stultifera Navis",url:"https://nivel20.com/s/11tglzczc",img:"",dpPendiente:true},
  {id:"erica",camp:0,emoji:"üî¨",name:"Erica Browning",cls:"‚Äî",faction:"Tripulaci√≥n Stultifera Navis",url:"https://nivel20.com/s/ux5vzczc",img:"",dpPendiente:true},
  {id:"alia",camp:0,emoji:"‚ú®",name:"Alia",cls:"‚Äî",faction:"Tripulaci√≥n Stultifera Navis",url:"https://nivel20.com/games/dnd-5/campaigns/45678-stultifera-navis/creatures/48366-alia",img:"",dpPendiente:true},
  {id:"ayre",camp:0,emoji:"üå∏",name:"Ayre Edelweiss",cls:"‚Äî",faction:"Tripulaci√≥n Stultifera Navis",url:"https://nivel20.com/s/1a4bvzczc",img:"",dpPendiente:true},
  {id:"pandora",camp:0,emoji:"üì¶",name:"Pandora",cls:"‚Äî",faction:"Tripulaci√≥n Stultifera Navis",url:"https://nivel20.com/s/1a7gwzczc",img:"",dpPendiente:true},
];

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let selected = new Set();
let activeTab = 0;
let activeFaction = {};
let editingId = null;
let pendingImg = "";

// ‚îÄ‚îÄ‚îÄ INVENTORY STATE ‚îÄ‚îÄ‚îÄ
let ITEMS = [];
let editingItemId = null;
let pendingItemImg = "";

// ‚îÄ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ‚îÄ
const ROLES = ["Tanque","Coloso","Asesino","Luchador","Especialista","Artillero M√°gico","Tirador","Soporte"];
const ROL_EMOJI = {"Tanque":"üõ°Ô∏è","Coloso":"üí™","Asesino":"üó°Ô∏è","Luchador":"‚öîÔ∏è","Especialista":"üîß","Artillero M√°gico":"üîÆ","Tirador":"üèπ","Soporte":"üíö"};

function buildTags(n){
  if(n.dpPendiente) return [{t:"‚è≥ DP pendientes",c:"pend"}];
  const t=[];
  if(n.fichaNivel){
    if(n.fichaParty && (parseInt(n.fichaSuperior)||0)>0) t.push({t:`üìã Nivel +${n.fichaSuperior} sobre party`,c:"my"});
    else if(n.fichaParty) t.push({t:"üìã Nivel de Party",c:"ep"});
    else t.push({t:"üìã Ficha de Nivel",c:"cg"});
  }
  if((parseInt(n.cargos)||0)>0) t.push({t:`Cargos √ó${n.cargos}`,c:"cg"});
  if(n.donEstrellas) t.push({t:"‚ú¶ Don de las Estrellas",c:"sp"});
  if(n.doteHeroico) t.push({t:"Dote Heroico",c:"my"});
  if(n.piedad) t.push({t:"Piedad",c:"ep"});
  if((parseInt(n.panteismo)||0)>0) t.push({t:`Pante√≠smo √ó${n.panteismo}`,c:"ep"});
  if((parseInt(n.bendEpicas)||0)>0) t.push({t:`Bend. √âpica √ó${n.bendEpicas}`,c:"ep"});
  if((parseInt(n.bendMiticas)||0)>0) t.push({t:`Bend. M√≠tica √ó${n.bendMiticas}`,c:"my"});
  if((parseInt(n.conjMiticos)||0)>0) t.push({t:`Conjuro M√≠tico √ó${n.conjMiticos}`,c:"my"});
  if((parseInt(n.maniMiticas)||0)>0) t.push({t:`Maniobra M√≠tica √ó${n.maniMiticas}`,c:"my"});
  if(n.armLegendaria) t.push({t:"Armadura Legendaria",c:"my"});
  if(n.armMuyRara) t.push({t:"Armadura Muy Rara",c:"ep"});
  if(n.armtoLegendario) t.push({t:"Armamento Legendario",c:"my"});
  if(n.armtoMuyRaro) t.push({t:"Armamento Muy Raro",c:"ep"});
  if((parseInt(n.altoPoder)||0)>0) t.push({t:`Alto Poder √ó${n.altoPoder}`,c:"wp"});
  if((parseInt(n.tesoroDivino)||0)>0) t.push({t:`Tesoro Divino √ó${n.tesoroDivino}`,c:"my"});
  if((parseInt(n.cartaEstrella)||0)>0) t.push({t:`‚≠ê La Estrella √ó${n.cartaEstrella}`,c:"sp"});
  if(n.cartaArbol) t.push({t:"üå≥ El √Årbol",c:"gr"});
  if((parseInt(n.transformacion)||0)>0) t.push({t:`‚ú® Transformaci√≥n √ó${n.transformacion}`,c:"sp"});
  if(n.avatar) t.push({t:`Avatar${(parseInt(n.rupturas)||0)>0?` (${n.rupturas} rupt.)`:""}`,c:"sp"});
  if(n.setPrimordial) t.push({t:"‚öúÔ∏è Set Primordial",c:"sp"});
  if(n.familiares) t.push({t:n.familiaresAltoPoder?"üëæ Familiares Alto Poder":"üëæ Familiares",c:n.familiaresAltoPoder?"wp":"ep"});
  if(n.claseAdicional) t.push({t:`Clase Adicional${(parseInt(n.clasesExtra)||0)>0?` √ó${n.clasesExtra}`:""}`,c:"cg"});
  if(n.cartaLanza) t.push({t:n.cartaLanzaHonor?"üó°Ô∏è La Lanza (Honor)":"üó°Ô∏è La Lanza",c:"wp"});
  if(n.subclaseAdicional) t.push({t:`Subclase Adicional √ó${Math.max(1,parseInt(n.subclasesExtra)||1)}`,c:"cg"});
  if(n.naturalezaLegendaria) t.push({t:`üåü Nat. Legendaria${(parseInt(n.dotesLegendarios)||0)>0?` (+${n.dotesLegendarios} dotes)`:""}`,c:"my"});
  return t;
}

// ‚îÄ‚îÄ‚îÄ RENDER CARD ‚îÄ‚îÄ‚îÄ
function renderCard(npc){
  const {dp,bd,pend}=calcDP(npc);
  const fi=FI[npc.faction]||{cls:"f-def",emoji:"?"};
  const isSel=selected.has(npc.id);
  const tags=buildTags(npc);
  const dpc=dpCls(dp);

  const tagHTML=tags.slice(0,5).map(t=>`<span class="tag ${t.c}">${t.t}</span>`).join("")
    +(tags.length>5?`<span class="tag">+${tags.length-5} m√°s</span>`:"");

  const bdHTML=pend
    ?`<p style="font-size:12px;color:var(--text3);font-style:italic">Usa el bot√≥n ‚úèÔ∏è para configurar los DP de este personaje.</p>`
    :bd.map(r=>`<div class="brow"><span>${r.l}</span><span class="bv">+${r.v}</span></div>`).join("");

  const linkHTML=npc.url
    ?`<a class="n20-link" href="${npc.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()"><svg width="10" height="10" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 2H3a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V9M13 3l-6 6M9 3h4v4"/></svg>Ver en Level20</a>`:"";

  const div=document.createElement("div");
  div.className=`card${isSel?" selected":""}`;
  div.id=`c-${npc.id}`;
  div.innerHTML=`
    <button class="cedit" title="Editar personaje">‚úèÔ∏è</button>
    <div class="card-head">
      <div class="ava">${npc.img?`<img src="${npc.img}" alt="${npc.name}">`:npc.emoji}</div>
      <div class="name-area">
        <div class="npc-name">${npc.name}</div>
        <div class="npc-class">${npc.cls}</div>
        <span class="npc-faction ${fi.cls}">${fi.emoji} ${npc.faction}</span>
        ${npc.rol?`<span class="npc-rol">${ROL_EMOJI[npc.rol]||""} ${npc.rol}</span>`:""}
      </div>
      <div class="dp-badge ${dpc}"><span class="n">${dp}</span><span class="u">DP</span></div>
    </div>
    <div class="card-body"><div class="tags">${tagHTML||'<span class="tag pend">Sin rasgos especiales</span>'}</div></div>
    <button class="bd-toggle" id="bt-${npc.id}"><span>${pend?"Configurar DP ‚Üí":`Desglose (${bd.length} factores)`}</span><span class="arr">‚ñæ</span></button>
    <div class="breakdown" id="bd-${npc.id}">${bdHTML}${linkHTML}</div>`;

  div.querySelector(".cedit").addEventListener("click",e=>{e.stopPropagation();openEditNPC(npc.id);});
  div.querySelector(".bd-toggle").addEventListener("click",e=>{
    e.stopPropagation();
    div.querySelector(`#bd-${npc.id}`).classList.toggle("open");
    div.querySelector(`#bt-${npc.id}`).classList.toggle("open");
  });
  div.addEventListener("click",()=>toggleNPC(npc.id));
  return div;
}

// ‚îÄ‚îÄ‚îÄ RENDER GRID ‚îÄ‚îÄ‚îÄ
function renderGrid(campId,faction,search){
  const grid=document.getElementById(`grid${campId}`);
  if(!grid) return;
  let list=NPCS.filter(n=>n.camp===campId);
  if(faction) list=list.filter(n=>n.faction===faction);
  if(search) list=list.filter(n=>n.name.toLowerCase().includes(search.toLowerCase()));
  grid.innerHTML="";
  if(!list.length){grid.innerHTML='<div class="empty-grid">No se encontraron personajes.</div>';return;}
  list.forEach(n=>grid.appendChild(renderCard(n)));
}

// ‚îÄ‚îÄ‚îÄ RENDER FACTION BTNS ‚îÄ‚îÄ‚îÄ
function renderFactionBtns(campId){
  const cont=document.getElementById(`fb${campId}`);
  if(!cont) return;
  cont.innerHTML="";
  const factions=[...new Set(NPCS.filter(n=>n.camp===campId).map(n=>n.faction))];
  const allBtn=document.createElement("button");
  allBtn.className="fbtn active";
  allBtn.textContent="Todas";
  allBtn.addEventListener("click",()=>{
    activeFaction[campId]=null;
    cont.querySelectorAll(".fbtn").forEach(b=>b.classList.remove("active"));
    allBtn.classList.add("active");
    renderGrid(campId,null,getSearch(campId));
  });
  cont.appendChild(allBtn);
  factions.forEach(f=>{
    const fi=FI[f]||{emoji:""};
    const btn=document.createElement("button");
    btn.className="fbtn";
    btn.textContent=`${fi.emoji} ${f}`;
    btn.addEventListener("click",()=>{
      activeFaction[campId]=f;
      cont.querySelectorAll(".fbtn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      renderGrid(campId,f,getSearch(campId));
    });
    cont.appendChild(btn);
  });
}

function getSearch(campId){
  return document.querySelector(`#panel${campId} .search`)?.value||"";
}

// ‚îÄ‚îÄ‚îÄ RENDER TABS & PANELS ‚îÄ‚îÄ‚îÄ
function renderTabs(){
  const container=document.getElementById("tabs-container");
  const actions=document.getElementById("tab-actions");
  container.innerHTML="";
  container.appendChild(actions);
  campaigns.forEach(c=>{
    const cnt=NPCS.filter(n=>n.camp===c.id).length;
    const btn=document.createElement("button");
    btn.className=`tab-btn${c.id===activeTab?" active":""}`;
    btn.innerHTML=`${c.name}<span class="cnt">${cnt}</span>`;
    btn.addEventListener("click",()=>switchTab(c.id));
    container.insertBefore(btn,actions);
  });
}

function renderPanels(){
  const main=document.getElementById("main-panels");
  main.innerHTML="";
  campaigns.forEach(c=>{
    const panel=document.createElement("div");
    panel.className=`tab-panel${c.id===activeTab?" active":""}`;
    panel.id=`panel${c.id}`;
    panel.innerHTML=`
      <div class="camp-title-row">
        <span class="camp-title" id="ctitle${c.id}">${c.name}</span>
        <button class="edit-cn-btn" title="Renombrar" onclick="startEditCampName(${c.id})">‚úèÔ∏è</button>
      </div>
      <div class="filters">
        <span class="filter-lbl">Facci√≥n:</span>
        <div class="faction-btns" id="fb${c.id}"></div>
        <input type="text" class="search" placeholder="Buscar‚Ä¶" oninput="renderGrid(${c.id},activeFaction[${c.id}],this.value)">
      </div>
      <div class="inv-section" id="inv-section${c.id}">
        <div class="inv-header">
          <span class="inv-title">üì¶ Inventario de Campa√±a <span class="inv-count" id="inv-count${c.id}">0</span></span>
          <button class="btn-new-item" id="btn-new-item-${c.id}" onclick="openNewItem(${c.id})" style="display:none">+ Agregar Art√≠culo</button>
        </div>
        <div class="inv-grid" id="inv-grid${c.id}"></div>
      </div>
      <div class="grid" id="grid${c.id}"></div>`;
    main.appendChild(panel);
  });
}

function fullRender(){
  renderTabs();
  renderPanels();
  campaigns.forEach(c=>{renderFactionBtns(c.id);renderGrid(c.id,activeFaction[c.id],null);renderInvGrid(c.id);});
  // respect auth state
  if(!isLoggedIn){
    document.querySelectorAll(".cedit").forEach(b=>b.style.display="none");
    document.querySelectorAll(".edit-cn-btn").forEach(b=>b.style.display="none");
    document.querySelectorAll(".icard-edit").forEach(b=>b.style.display="none");
    document.querySelectorAll(".btn-new-item").forEach(b=>b.style.display="none");
  }
}

// ‚îÄ‚îÄ‚îÄ INTERACTIONS ‚îÄ‚îÄ‚îÄ
function switchTab(id){
  activeTab=id;
  document.querySelectorAll(".tab-btn").forEach(b=>{
    b.classList.remove("active");
    if(b.textContent.startsWith(campaigns.find(c=>c.id===id)?.name)) b.classList.add("active");
  });
  document.querySelectorAll(".tab-panel").forEach(p=>p.classList.toggle("active",p.id===`panel${id}`));
  // re-activate correct tab btn
  renderTabs();
}

function toggleNPC(id){
  selected.has(id)?selected.delete(id):selected.add(id);
  const card=document.getElementById(`c-${id}`);
  if(card) card.classList.toggle("selected",selected.has(id));
  updatePanel();
}

function updatePanel(){
  const panel=document.getElementById("selPanel");
  const chips=document.getElementById("selChips");
  const totalEl=document.getElementById("totalDP");
  const hdrDp=document.getElementById("hdr-dp");
  const hdrCnt=document.getElementById("hdr-cnt");
  if(!selected.size){
    panel.classList.remove("vis");totalEl.textContent="0";hdrDp.textContent="0";hdrCnt.textContent="Ninguno";return;
  }
  panel.classList.add("vis");
  let total=0,hasPend=false,html="";
  selected.forEach(id=>{
    const npc=NPCS.find(n=>n.id===id);if(!npc)return;
    const {dp,pend}=calcDP(npc);
    if(pend)hasPend=true;else total+=dp;
    const avaHtml=npc.img?`<img src="${npc.img}" style="width:18px;height:18px;border-radius:50%;object-fit:cover">`:npc.emoji;
    html+=`<div class="chip">${avaHtml} ${npc.name}<span class="chip-dp">${pend?"?":dp} DP</span><button class="chip-x" onclick="event.stopPropagation();toggleNPC('${id}')">√ó</button></div>`;
  });
  chips.innerHTML=html;
  const disp=hasPend?`${total}+`:String(total);
  totalEl.textContent=disp;hdrDp.textContent=disp;
  hdrCnt.textContent=`${selected.size} NPC${selected.size>1?"s":""}`;
}

function clearAll(){
  selected.clear();
  document.querySelectorAll(".card.selected").forEach(c=>c.classList.remove("selected"));
  updatePanel();
}

// ‚îÄ‚îÄ‚îÄ CAMPAIGN MANAGEMENT ‚îÄ‚îÄ‚îÄ
async function addCampaign(){
  const name=prompt("Nombre de la nueva campa√±a:");
  if(!name?.trim()) return;
  const newId=Math.max(...campaigns.map(c=>c.id))+1;
  await sbFetch("campaigns",{method:"POST",body:JSON.stringify({id:newId,name:name.trim()})});
  campaigns.push({id:newId,name:name.trim()});
  activeFaction[newId]=null;
  fullRender();
  switchTab(newId);
}

async function renameCampaign(campId, newName){
  await sbFetch("campaigns?id=eq."+campId,{method:"PATCH",body:JSON.stringify({name:newName})});
}

function startEditCampName(campId){
  const titleEl=document.getElementById(`ctitle${campId}`);
  const camp=campaigns.find(c=>c.id===campId);
  if(!camp||!titleEl) return;
  const input=document.createElement("input");
  input.type="text";input.className="camp-name-input";input.value=camp.name;
  titleEl.replaceWith(input);
  input.focus();input.select();
  const done=()=>{
    const newName=input.value.trim()||camp.name;
    if(newName!==camp.name){ camp.name=newName; renameCampaign(campId,newName); }
    fullRender();
  };
  input.addEventListener("blur",done);
  input.addEventListener("keydown",e=>{if(e.key==="Enter")done();if(e.key==="Escape"){input.value=camp.name;done();}});
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ
function openNewNPC(){
  editingId=null;pendingImg="";
  document.getElementById("modal-title").textContent="Nuevo Personaje";
  document.getElementById("btn-del").style.display="none";
  buildModalForm(null);
  document.getElementById("npcModal").classList.add("open");
}

function openEditNPC(id){
  editingId=id;pendingImg="";
  const npc=NPCS.find(n=>n.id===id);
  document.getElementById("modal-title").textContent=`Editar: ${npc.name}`;
  document.getElementById("btn-del").style.display="block";
  buildModalForm(npc);
  document.getElementById("npcModal").classList.add("open");
}

function closeModal(){
  document.getElementById("npcModal").classList.remove("open");
  editingId=null;pendingImg="";
}

// helper: check row with optional number field
function cr(id,label,dph,numId,v){
  const hasNum=!!numId;
  return `<div class="cr" id="cr_${id}">
    <input type="checkbox" id="${id}">
    <label for="${id}">${label}</label>
    <span class="dph">${dph}</span>
    ${hasNum?`<input type="number" class="cnum" id="${numId}" min="0" value="${v||0}" disabled>`:``}
  </div>`;
}
function sr(id,label,dph){
  return `<div class="sr"><input type="checkbox" id="${id}"><label for="${id}">${label}</label><span class="dph">${dph}</span></div>`;
}
function sub(id,html){
  return `<div class="sub-list" id="sub_${id}">${html}</div>`;
}

function buildModalForm(n){
  const campOpts=campaigns.map(c=>`<option value="${c.id}"${n&&n.camp===c.id?" selected":""}>${c.name}</option>`).join("");
  const facOpts=Object.keys(FI).map(f=>`<option value="${f}"${n&&n.faction===f?" selected":""}>${FI[f].emoji} ${f}</option>`).join("")
    +`<option value="__new">+ Nueva Facci√≥n‚Ä¶</option>`;
  const rolOpts=`<option value="">‚Äî Sin rol ‚Äî</option>`+ROLES.map(r=>`<option value="${r}"${n?.rol===r?" selected":""}>${ROL_EMOJI[r]||""} ${r}</option>`).join("");
  const imgPreview=n?.img?`<img class="img-prev" id="img-prev" src="${n.img}">`:`<div id="img-prev"></div>`;

  document.getElementById("modal-body").innerHTML=`
<div class="fsec">
  <div class="fsec-t">Informaci√≥n General</div>
  <div class="frow">
    <div class="fg"><label>Nombre</label><input type="text" id="f_name" value="${n?.name||""}"></div>
    <div class="fg"><label>Clase / Nivel</label><input type="text" id="f_cls" value="${n?.cls||""}"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Campa√±a</label><select id="f_camp">${campOpts}</select></div>
    <div class="fg"><label>Facci√≥n</label><select id="f_fac" onchange="onFacChange(this)">${facOpts}</select></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Rol</label><select id="f_rol">${rolOpts}</select></div>
    <div class="fg"><label>Emoji</label><input type="text" id="f_emoji" value="${n?.emoji||"‚öîÔ∏è"}" maxlength="4"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Link Level20</label><input type="text" id="f_url" value="${n?.url||""}"></div>
  </div>
  <div class="frow full">
    <div class="fg">
      <label>Imagen</label>
      <div class="img-area">
        <input type="file" accept="image/*" onchange="onImgUpload(this)">
        ${imgPreview}
        <div class="img-txt" id="img-txt">${n?.img?"Clic para cambiar":"Clic o arrastra una imagen"}</div>
      </div>
    </div>
  </div>
</div>

<div class="fsec">
  <div class="fsec-t">Puntos de Despliegue</div>
  <div style="display:flex;align-items:center;gap:9px;margin-bottom:12px">
    <input type="checkbox" id="f_dpPend" onchange="toggleDP(this)" ${n?.dpPendiente!==false?"checked":""}>
    <label for="f_dpPend" style="font-size:13px;color:var(--text2)">DP Pendientes de configurar</label>
  </div>
  <div id="dp_fields" style="${n?.dpPendiente===false?"":"display:none"}">

    <div style="margin:0 0 8px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Tipo de Ficha</div>
    ${cr("f_fichaNivel","Ficha de Nivel (no de criatura)","+1 DP")}
    ${sub("f_fichaNivel",
      sr("f_fichaParty","Nivel de la Party","+1 DP")+
      `<div class="sub-list" id="sub_f_fichaParty">
        <div class="sr"><label style="flex:1">Niveles por encima de la party</label><span class="dph">√ó1 DP c/u</span><input type="number" id="f_fichaSuperior" min="0" value="${n?.fichaSuperior||0}" disabled style="width:52px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-size:13px;outline:none"></div>
      </div>`
    )}

    ${cr("f_cargos","Cargos Importantes","√ó1 DP c/u","f_cargos_n",n?.cargos)}
    ${cr("f_donEstrellas","Don de las Estrellas","+2 DP")}
    ${cr("f_doteHeroico","Dote Heroico","+1 DP")}
    ${cr("f_piedad","Poseer una Piedad","+1 DP")}
    ${cr("f_panteismo","Piedad de Pante√≠smo","√ó1 DP/dios","f_panteismo_n",n?.panteismo)}

    <div style="margin:10px 0 6px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Poderes M√≠ticos y √âpicos</div>
    ${cr("f_bendEpicas","Bendiciones √âpicas","√ó1 DP c/u","f_bendEpicas_n",n?.bendEpicas)}
    ${cr("f_bendMiticas","Bendiciones M√≠ticas","√ó1 DP c/u","f_bendMiticas_n",n?.bendMiticas)}
    ${cr("f_conjMiticos","Conjuros M√≠ticos","√ó1 DP c/u","f_conjMiticos_n",n?.conjMiticos)}
    ${cr("f_maniMiticas","Maniobras M√≠ticas","√ó1 DP c/u","f_maniMiticas_n",n?.maniMiticas)}

    <div style="margin:10px 0 6px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Entrenamientos</div>
    ${cr("f_entrAtrib","‚â•2 Entrenamientos de Atributos","+1 DP","f_entrAtrib_n",n?.entrAtrib)}
    ${cr("f_entrSalv","‚â•2 Entrenamientos de Salvaciones","+1 DP","f_entrSalv_n",n?.entrSalv)}
    ${cr("f_dotesEntr","‚â•2 Dotes Entrenados","+1 DP","f_dotesEntr_n",n?.dotesEntr)}
    ${cr("f_rasgosEntr","Rasgos Especiales Entrenados","cada 2 = +1 DP","f_rasgosEntr_n",n?.rasgosEntr)}

    <div style="margin:10px 0 6px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Equipamiento</div>
    ${cr("f_equipCompleto","Equipamiento Completo","+1 DP")}
    ${cr("f_armMuyRara","Armadura Muy Rara (ej. Elerio)","+2 DP")}
    ${sub("f_armMuyRara",sr("f_escMuyRaro","Escudo Muy Raro","+2 DP")+sr("f_servoMuyRara","Servo-Armadura (Muy Rara)","+1 DP"))}
    ${cr("f_armLegendaria","Armadura Legendaria (ej. Auramita)","+4 DP")}
    ${sub("f_armLegendaria",sr("f_escLegendario","Escudo Legendario","+4 DP")+sr("f_servoLegendaria","Servo-Armadura (Legendaria)","+2 DP"))}
    ${cr("f_armtoMuyRaro","Armamento Muy Raro","+2 DP")}
    ${sub("f_armtoMuyRaro",sr("f_armtoMuyRaroMas2","M√°s de 2 piezas Muy Raras","+1 DP"))}
    ${cr("f_armtoLegendario","Armamento Legendario","+4 DP")}
    ${sub("f_armtoLegendario",sr("f_armtoLegendarioMas2","M√°s de 2 piezas Legendarias","+2 DP"))}
    ${cr("f_altoPoder","Armamento Alto Poder Destructivo","√ó3 DP c/u","f_altoPoder_n",n?.altoPoder)}
    ${cr("f_consumibles","Consumibles/Munici√≥n Alto Poder","√ó1 DP/tipo","f_consumibles_n",n?.consumibles)}
    ${cr("f_tesoroDivino","Tesoro Divino/Legendario","√ó5 DP c/u","f_tesoroDivino_n",n?.tesoroDivino)}

    <div style="margin:10px 0 6px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Cartas</div>
    ${cr("f_cartasMazo","Cartas Mazo Muchas Cosas (atributos)","√ó1 DP c/u","f_cartasMazo_n",n?.cartasMazo)}
    ${cr("f_cartaEstrella","Carta: La Estrella","√ó3 DP c/vez","f_cartaEstrella_n",n?.cartaEstrella)}
    ${cr("f_cartaArbol","Carta: El √Årbol","+4 DP")}
    ${cr("f_cartaLanza","Carta: La Lanza","+3 DP")}
    ${sub("f_cartaLanza",sr("f_cartaLanzaHonor","Se juega con Honor y Cordura","+1 DP"))}

    <div style="margin:10px 0 6px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--text3)">Otros</div>
    ${cr("f_setPrimordial","Set Primordial Completo","+4 DP")}
    ${cr("f_familiares","Familiares en Combate","+2 DP")}
    ${sub("f_familiares",sr("f_familiaresAltoPoder","Familiares de Alto Poder","+4 DP"))}
    ${cr("f_claseAdicional","Clase Adicional","+3 DP")}
    ${sub("f_claseAdicional",`<div class="sr"><label style="flex:1">Clases Extra</label><span class="dph">√ó2 DP c/u</span><input type="number" id="f_clasesExtra" min="0" value="${n?.clasesExtra||0}" disabled style="width:52px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-size:13px;outline:none"></div>`)}
    ${cr("f_subclaseAdicional","Subclase Adicional","√ó2 DP c/u")}
    ${sub("f_subclaseAdicional",`<div class="sr"><label style="flex:1">Subclases Extra</label><span class="dph">√ó2 DP c/u (m√≠n 1)</span><input type="number" id="f_subclasesExtra" min="1" value="${Math.max(1,n?.subclasesExtra||1)}" disabled style="width:52px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-size:13px;outline:none"></div>`)}
    ${cr("f_naturalezaLegendaria","Naturaleza Legendaria","+3 DP")}
    ${sub("f_naturalezaLegendaria",`<div class="sr"><label style="flex:1">Dotes Legendarios</label><span class="dph">√ó2 DP c/u</span><input type="number" id="f_dotesLegendarios" min="0" value="${n?.dotesLegendarios||0}" disabled style="width:52px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-size:13px;outline:none"></div>`)}
    ${cr("f_objAtrib","Objetos/Modif. que suban Atributos","√ó1 DP c/u","f_objAtrib_n",n?.objAtrib)}
    ${cr("f_transformacion","Transformaci√≥n Sobrenatural","√ó2 DP c/u","f_transformacion_n",n?.transformacion)}
    ${cr("f_avatar","Avatar de una Divinidad","+3 DP")}
    ${sub("f_avatar",`<div class="sr"><label style="flex:1">Rupturas del L√≠mite</label><span class="dph">√ó2 DP c/u</span><input type="number" id="f_rupturas" min="0" value="${n?.rupturas||0}" disabled style="width:52px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-size:13px;outline:none"></div>`)}

  </div>
</div>`;

  // Set checked states if editing
  if(n && n.dpPendiente===false){
    const checks={
      f_fichaNivel:(n.fichaNivel||false), f_fichaParty:(n.fichaParty||false),
      f_cargos:(n.cargos||0)>0, f_donEstrellas:n.donEstrellas,
      f_doteHeroico:n.doteHeroico, f_piedad:n.piedad, f_panteismo:(n.panteismo||0)>0,
      f_bendEpicas:(n.bendEpicas||0)>0, f_bendMiticas:(n.bendMiticas||0)>0,
      f_conjMiticos:(n.conjMiticos||0)>0, f_maniMiticas:(n.maniMiticas||0)>0,
      f_entrAtrib:(n.entrAtrib||0)>0, f_entrSalv:(n.entrSalv||0)>0,
      f_dotesEntr:(n.dotesEntr||0)>0, f_rasgosEntr:(n.rasgosEntr||0)>0,
      f_equipCompleto:n.equipCompleto, f_armMuyRara:n.armMuyRara,
      f_escMuyRaro:n.escMuyRaro, f_servoMuyRara:n.servoMuyRara,
      f_armLegendaria:n.armLegendaria, f_escLegendario:n.escLegendario, f_servoLegendaria:n.servoLegendaria,
      f_armtoMuyRaro:n.armtoMuyRaro, f_armtoMuyRaroMas2:n.armtoMuyRaroMas2,
      f_armtoLegendario:n.armtoLegendario, f_armtoLegendarioMas2:n.armtoLegendarioMas2,
      f_altoPoder:(n.altoPoder||0)>0, f_consumibles:(n.consumibles||0)>0,
      f_tesoroDivino:(n.tesoroDivino||0)>0,
      f_cartasMazo:(n.cartasMazo||0)>0, f_cartaEstrella:(n.cartaEstrella||0)>0,
      f_cartaArbol:n.cartaArbol,
      f_cartaLanza:(n.cartaLanza||false), f_cartaLanzaHonor:(n.cartaLanzaHonor||false),
      f_setPrimordial:n.setPrimordial, f_objAtrib:(n.objAtrib||0)>0,
      f_familiares:(n.familiares||false), f_familiaresAltoPoder:(n.familiaresAltoPoder||false),
      f_claseAdicional:(n.claseAdicional||false),
      f_subclaseAdicional:(n.subclaseAdicional||false),
      f_naturalezaLegendaria:(n.naturalezaLegendaria||false),
      f_transformacion:(n.transformacion||0)>0, f_avatar:n.avatar,
    };
    Object.entries(checks).forEach(([id,val])=>{const el=document.getElementById(id);if(el)el.checked=!!val;});

    // enable num fields
    ["f_cargos","f_panteismo","f_bendEpicas","f_bendMiticas","f_conjMiticos","f_maniMiticas",
     "f_entrAtrib","f_entrSalv","f_dotesEntr","f_rasgosEntr","f_altoPoder","f_consumibles",
     "f_tesoroDivino","f_cartasMazo","f_cartaEstrella","f_objAtrib","f_transformacion"].forEach(id=>{
      const cb=document.getElementById(id);const numEl=document.getElementById(id+"_n");
      if(cb&&numEl)numEl.disabled=!cb.checked;
    });
    const av=document.getElementById("f_avatar");const ru=document.getElementById("f_rupturas");
    if(av&&ru)ru.disabled=!av.checked;
    const clA=document.getElementById("f_claseAdicional");const ceEl=document.getElementById("f_clasesExtra");
    if(clA&&ceEl)ceEl.disabled=!clA.checked;
    const scA=document.getElementById("f_subclaseAdicional");const scE=document.getElementById("f_subclasesExtra");
    if(scA&&scE)scE.disabled=!scA.checked;
    const nlA=document.getElementById("f_naturalezaLegendaria");const dlE=document.getElementById("f_dotesLegendarios");
    if(nlA&&dlE)dlE.disabled=!nlA.checked;

    // show sub-lists
    ["f_armMuyRara","f_armLegendaria","f_armtoMuyRaro","f_armtoLegendario","f_familiares","f_claseAdicional","f_subclaseAdicional","f_naturalezaLegendaria","f_cartaLanza","f_avatar","f_fichaNivel","f_fichaParty"].forEach(id=>{
      const cb=document.getElementById(id);const sub=document.getElementById("sub_"+id);
      if(cb&&sub) sub.classList.toggle("show",cb.checked);
    });
    // enable fichaSuperior if fichaParty checked
    const fp=document.getElementById("f_fichaParty");const fs=document.getElementById("f_fichaSuperior");
    if(fp&&fs)fs.disabled=!fp.checked;
  }

  // Attach change listeners
  setTimeout(()=>{
    ["f_cargos","f_panteismo","f_bendEpicas","f_bendMiticas","f_conjMiticos","f_maniMiticas",
     "f_entrAtrib","f_entrSalv","f_dotesEntr","f_rasgosEntr","f_altoPoder","f_consumibles",
     "f_tesoroDivino","f_cartasMazo","f_cartaEstrella","f_objAtrib","f_transformacion"].forEach(id=>{
      const cb=document.getElementById(id);if(!cb)return;
      cb.addEventListener("change",()=>{
        const numEl=document.getElementById(id+"_n");
        if(numEl){numEl.disabled=!cb.checked;if(cb.checked)numEl.focus();}
      });
    });
    ["f_armMuyRara","f_armLegendaria","f_armtoMuyRaro","f_armtoLegendario","f_familiares","f_claseAdicional","f_subclaseAdicional","f_naturalezaLegendaria","f_cartaLanza","f_avatar","f_fichaNivel","f_fichaParty"].forEach(id=>{
      const cb=document.getElementById(id);if(!cb)return;
      cb.addEventListener("change",()=>{
        const sub=document.getElementById("sub_"+id);if(sub)sub.classList.toggle("show",cb.checked);
        if(id==="f_avatar"){const ru=document.getElementById("f_rupturas");if(ru)ru.disabled=!cb.checked;}
        if(id==="f_claseAdicional"){const ce=document.getElementById("f_clasesExtra");if(ce)ce.disabled=!cb.checked;}
        if(id==="f_subclaseAdicional"){const se=document.getElementById("f_subclasesExtra");if(se){se.disabled=!cb.checked;if(cb.checked)se.focus();}}
        if(id==="f_naturalezaLegendaria"){const de=document.getElementById("f_dotesLegendarios");if(de){de.disabled=!cb.checked;if(cb.checked)de.focus();}}
        if(id==="f_fichaParty"){const fs=document.getElementById("f_fichaSuperior");if(fs){fs.disabled=!cb.checked;if(cb.checked)fs.focus();}}
      });
    });
  },0);
}

function toggleDP(cb){
  document.getElementById("dp_fields").style.display=cb.checked?"none":"block";
}

function onFacChange(sel){
  if(sel.value==="__new"){
    const name=prompt("Nombre de la nueva facci√≥n:");
    if(name?.trim()){
      FI[name.trim()]={cls:"f-def",emoji:"‚öîÔ∏è"};
      const opt=document.createElement("option");
      opt.value=name.trim();opt.textContent=name.trim();opt.selected=true;
      sel.insertBefore(opt,sel.lastElementChild);sel.value=name.trim();
    } else sel.value=Object.keys(FI)[0];
  }
}

function onImgUpload(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    pendingImg=e.target.result;
    const prev=document.getElementById("img-prev");
    if(prev.tagName==="IMG"){prev.src=pendingImg;}
    else{const img=document.createElement("img");img.className="img-prev";img.id="img-prev";img.src=pendingImg;prev.replaceWith(img);}
    const txt=document.getElementById("img-txt");if(txt)txt.textContent="Clic para cambiar";
  };
  reader.readAsDataURL(file);
}

function gv(id){const el=document.getElementById(id);return el?el.value:"";}
function gc(id){const el=document.getElementById(id);return el?el.checked:false;}
function gn(id){const el=document.getElementById(id);return el&&!el.disabled?parseInt(el.value)||0:0;}

async function saveNPC(){
  const name=gv("f_name").trim();if(!name){alert("El nombre es obligatorio.");return;}
  const imgData=pendingImg||(editingId?NPCS.find(n=>n.id===editingId)?.img:"");
  const data={
    name,cls:gv("f_cls")||"‚Äî",camp:parseInt(gv("f_camp")),faction:gv("f_fac"),
    rol:gv("f_rol")||"",
    emoji:gv("f_emoji")||"‚öîÔ∏è",url:gv("f_url"),img:imgData||"",
    dpPendiente:gc("f_dpPend"),
    fichaNivel:gc("f_fichaNivel"),fichaParty:gc("f_fichaParty"),
    fichaSuperior:gc("f_fichaParty")?parseInt(document.getElementById("f_fichaSuperior")?.value)||0:0,
    cargos:gn("f_cargos_n"),donEstrellas:gc("f_donEstrellas"),
    doteHeroico:gc("f_doteHeroico"),piedad:gc("f_piedad"),panteismo:gn("f_panteismo_n"),
    bendEpicas:gn("f_bendEpicas_n"),bendMiticas:gn("f_bendMiticas_n"),
    conjMiticos:gn("f_conjMiticos_n"),maniMiticas:gn("f_maniMiticas_n"),
    entrAtrib:gn("f_entrAtrib_n"),entrSalv:gn("f_entrSalv_n"),dotesEntr:gn("f_dotesEntr_n"),rasgosEntr:gn("f_rasgosEntr_n"),
    equipCompleto:gc("f_equipCompleto"),
    armMuyRara:gc("f_armMuyRara"),escMuyRaro:gc("f_escMuyRaro"),servoMuyRara:gc("f_servoMuyRara"),
    armLegendaria:gc("f_armLegendaria"),escLegendario:gc("f_escLegendario"),servoLegendaria:gc("f_servoLegendaria"),
    armtoMuyRaro:gc("f_armtoMuyRaro"),armtoMuyRaroMas2:gc("f_armtoMuyRaroMas2"),
    armtoLegendario:gc("f_armtoLegendario"),armtoLegendarioMas2:gc("f_armtoLegendarioMas2"),
    altoPoder:gn("f_altoPoder_n"),consumibles:gn("f_consumibles_n"),
    tesoroDivino:gn("f_tesoroDivino_n"),
    setPrimordial:gc("f_setPrimordial"),
    cartasMazo:gn("f_cartasMazo_n"),cartaEstrella:gn("f_cartaEstrella_n"),cartaArbol:gc("f_cartaArbol"),
    cartaLanza:gc("f_cartaLanza"),cartaLanzaHonor:gc("f_cartaLanzaHonor"),
    objAtrib:gn("f_objAtrib_n"),transformacion:gn("f_transformacion_n"),
    familiares:gc("f_familiares"),familiaresAltoPoder:gc("f_familiaresAltoPoder"),
    claseAdicional:gc("f_claseAdicional"),clasesExtra:gc("f_claseAdicional")?parseInt(document.getElementById("f_clasesExtra")?.value)||0:0,
    subclaseAdicional:gc("f_subclaseAdicional"),subclasesExtra:gc("f_subclaseAdicional")?Math.max(1,parseInt(document.getElementById("f_subclasesExtra")?.value)||1):0,
    naturalezaLegendaria:gc("f_naturalezaLegendaria"),dotesLegendarios:gc("f_naturalezaLegendaria")?parseInt(document.getElementById("f_dotesLegendarios")?.value)||0:0,
    avatar:gc("f_avatar"),rupturas:gn("f_rupturas"),
  };

  showToast("Guardando‚Ä¶",false);

  if(editingId){
    data.id=editingId;
    const row=npcToRow(data);
    await sbFetch("npcs?id=eq."+editingId,{method:"PATCH",body:JSON.stringify(row)});
    const idx=NPCS.findIndex(n=>n.id===editingId);
    if(idx>=0)NPCS[idx]={...NPCS[idx],...data};
  } else {
    data.id="npc_"+Date.now();
    const row=npcToRow(data);
    await sbFetch("npcs",{method:"POST",body:JSON.stringify(row)});
    NPCS.push(data);
  }
  showToast("‚úì Guardado");
  pendingImg="";closeModal();fullRender();updatePanel();
}

async function deleteNPC(){
  if(!editingId)return;
  const npc=NPCS.find(n=>n.id===editingId);
  if(!confirm(`¬øEliminar a ${npc?.name}? No se puede deshacer.`))return;
  await sbFetch("npcs?id=eq."+editingId,{method:"DELETE"});
  selected.delete(editingId);NPCS=NPCS.filter(n=>n.id!==editingId);
  showToast("‚úì Eliminado");
  closeModal();fullRender();updatePanel();
}

// ‚îÄ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ‚îÄ
const SB_URL = "https://rabupsafjsaahebpnzxq.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhYnVwc2FmanNhYWhlYnBuenhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODg4NjgsImV4cCI6MjA4NzU2NDg2OH0.lnIt6E65BRGAZOHXnELTT3A1-AZuXi8-PGaji4Dtobw";

async function sbFetch(path, opts={}){
  const res = await fetch(SB_URL+"/rest/v1/"+path, {
    headers:{"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY,"Content-Type":"application/json","Prefer":"return=representation",...(opts.headers||{})},
    ...opts
  });
  if(!res.ok){ const e=await res.text(); console.error("SB error:",e); return null; }
  const txt=await res.text();
  return txt?JSON.parse(txt):null;
}

// NPC row ‚Üî JS object mappers
function rowToNPC(r){
  return {
    id:r.id, camp:r.camp, name:r.name, cls:r.cls||"‚Äî", faction:r.faction||"",
    rol:r.rol||"", emoji:r.emoji||"‚öîÔ∏è", url:r.url||"", img:r.img||"",
    dpPendiente:r.dp_pendiente,
    fichaNivel:r.ficha_nivel||false, fichaParty:r.ficha_party||false, fichaSuperior:r.ficha_superior||0,
    cargos:r.cargos||0, donEstrellas:r.don_estrellas,
    doteHeroico:r.dote_heroico, piedad:r.piedad, panteismo:r.panteismo||0,
    bendEpicas:r.bend_epicas||0, bendMiticas:r.bend_miticas||0,
    conjMiticos:r.conj_miticos||0, maniMiticas:r.mani_miticas||0,
    entrAtrib:r.entr_atrib||0, entrSalv:r.entr_salv||0,
    dotesEntr:r.dotes_entr||0, rasgosEntr:r.rasgos_entr||0,
    equipCompleto:r.equip_completo,
    armMuyRara:r.arm_muy_rara, escMuyRaro:r.esc_muy_raro, servoMuyRara:r.servo_muy_rara,
    armLegendaria:r.arm_legendaria, escLegendario:r.esc_legendario, servoLegendaria:r.servo_legendaria,
    armtoMuyRaro:r.armto_muy_raro, armtoMuyRaroMas2:r.armto_muy_raro_mas2,
    armtoLegendario:r.armto_legendario, armtoLegendarioMas2:r.armto_legendario_mas2,
    altoPoder:r.alto_poder||0, consumibles:r.consumibles||0,
    tesoroDivino:r.tesoro_divino||0,
    cartasMazo:r.cartas_mazo||0, cartaEstrella:r.carta_estrella||0, cartaArbol:r.carta_arbol||false,
    cartaLanza:r.carta_lanza||false, cartaLanzaHonor:r.carta_lanza_honor||false,
    objAtrib:r.obj_atrib||0, transformacion:r.transformacion||0,
    familiares:r.familiares||false, familiaresAltoPoder:r.familiares_alto_poder||false,
    claseAdicional:r.clase_adicional||false, clasesExtra:r.clases_extra||0,
    subclaseAdicional:r.subclase_adicional||false, subclasesExtra:r.subclases_extra||1,
    naturalezaLegendaria:r.naturaleza_legendaria||false, dotesLegendarios:r.dotes_legendarios||0,
    avatar:r.avatar, rupturas:r.rupturas||0, setPrimordial:r.set_primordial,
  };
}

function npcToRow(n){
  return {
    id:n.id, camp:n.camp, name:n.name, cls:n.cls||"‚Äî", faction:n.faction,
    rol:n.rol||"", emoji:n.emoji||"‚öîÔ∏è", url:n.url||"", img:n.img||"",
    dp_pendiente:n.dpPendiente,
    ficha_nivel:!!n.fichaNivel, ficha_party:!!n.fichaParty, ficha_superior:n.fichaSuperior||0,
    cargos:n.cargos||0, don_estrellas:!!n.donEstrellas,
    dote_heroico:!!n.doteHeroico, piedad:!!n.piedad, panteismo:n.panteismo||0,
    bend_epicas:n.bendEpicas||0, bend_miticas:n.bendMiticas||0,
    conj_miticos:n.conjMiticos||0, mani_miticas:n.maniMiticas||0,
    entr_atrib:n.entrAtrib||0, entr_salv:n.entrSalv||0,
    dotes_entr:n.dotesEntr||0, rasgos_entr:n.rasgosEntr||0,
    equip_completo:!!n.equipCompleto,
    arm_muy_rara:!!n.armMuyRara, esc_muy_raro:!!n.escMuyRaro, servo_muy_rara:!!n.servoMuyRara,
    arm_legendaria:!!n.armLegendaria, esc_legendario:!!n.escLegendario, servo_legendaria:!!n.servoLegendaria,
    armto_muy_raro:!!n.armtoMuyRaro, armto_muy_raro_mas2:!!n.armtoMuyRaroMas2,
    armto_legendario:!!n.armtoLegendario, armto_legendario_mas2:!!n.armtoLegendarioMas2,
    alto_poder:n.altoPoder||0, consumibles:n.consumibles||0,
    tesoro_divino:n.tesoroDivino||0,
    cartas_mazo:n.cartasMazo||0, carta_estrella:n.cartaEstrella||0, carta_arbol:!!n.cartaArbol,
    carta_lanza:!!n.cartaLanza, carta_lanza_honor:!!n.cartaLanzaHonor,
    obj_atrib:n.objAtrib||0, transformacion:n.transformacion||0,
    familiares:!!n.familiares, familiares_alto_poder:!!n.familiaresAltoPoder,
    clase_adicional:!!n.claseAdicional, clases_extra:n.clasesExtra||0,
    subclase_adicional:!!n.subclaseAdicional, subclases_extra:n.subclasesExtra||1,
    naturaleza_legendaria:!!n.naturalezaLegendaria, dotes_legendarios:n.dotesLegendarios||0,
    avatar:!!n.avatar, rupturas:n.rupturas||0, set_primordial:!!n.setPrimordial,
  };
}

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ
const AUTH_USER = "jugador";
const AUTH_PASS = "sabydom2026";
let isLoggedIn = false;

function authClick(){
  if(isLoggedIn){ logout(); } else { openLogin(); }
}
function openLogin(){
  document.getElementById("loginModal").classList.add("open");
  document.getElementById("login-user").value="";
  document.getElementById("login-pass").value="";
  document.getElementById("login-err").textContent="";
  setTimeout(()=>document.getElementById("login-user").focus(),50);
}
function closeLogin(){
  document.getElementById("loginModal").classList.remove("open");
}
function doLogin(){
  const u=document.getElementById("login-user").value.trim();
  const p=document.getElementById("login-pass").value;
  if(u===AUTH_USER && p===AUTH_PASS){
    isLoggedIn=true;
    closeLogin();
    const btn=document.getElementById("auth-btn");
    btn.textContent="üîì jugador";
    btn.classList.add("logged");
    document.getElementById("btn-new-npc").style.display="";
    document.getElementById("btn-new-camp").style.display="";
    // show edit buttons on all cards
    document.querySelectorAll(".cedit").forEach(b=>b.style.display="");
    // show campaign rename buttons
    document.querySelectorAll(".edit-cn-btn").forEach(b=>b.style.display="");
    document.querySelectorAll(".icard-edit").forEach(b=>b.style.display="");
    document.querySelectorAll(".btn-new-item").forEach(b=>b.style.display="");
  } else {
    document.getElementById("login-err").textContent="Usuario o contrase√±a incorrectos.";
    document.getElementById("login-pass").value="";
    document.getElementById("login-pass").focus();
  }
}
function logout(){
  if(!confirm("¬øSalir del modo edici√≥n?")) return;
  isLoggedIn=false;
  const btn=document.getElementById("auth-btn");
  btn.innerHTML="üîí Editar";
  btn.classList.remove("logged");
  document.getElementById("btn-new-npc").style.display="none";
  document.getElementById("btn-new-camp").style.display="none";
  document.querySelectorAll(".cedit").forEach(b=>b.style.display="none");
  document.querySelectorAll(".edit-cn-btn").forEach(b=>b.style.display="none");
  document.querySelectorAll(".icard-edit").forEach(b=>b.style.display="none");
  document.querySelectorAll(".btn-new-item").forEach(b=>b.style.display="none");
}

// ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ
function openExport(){
  const sel=document.getElementById("exp-camp");
  sel.innerHTML=`<option value="all">Todas las campa√±as</option>`
    +campaigns.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
  document.getElementById("exportModal").classList.add("open");
}
function closeExport(){
  document.getElementById("exportModal").classList.remove("open");
}

function getExportRows(){
  const campVal=document.getElementById("exp-camp").value;
  let list = campVal==="all" ? NPCS : NPCS.filter(n=>n.camp===parseInt(campVal));
  return list.map(n=>{
    const camp=campaigns.find(c=>c.id===n.camp)?.name||"";
    const {dp}=calcDP(n);
    return {
      "Campa√±a":camp, "Nombre":n.name, "Clase":n.cls, "Facci√≥n":n.faction,
      "Rol":n.rol||"", "DP":dp==="?"?"Pendiente":dp,
      "Link Level20":n.url||"",
      "DP Pendiente":n.dpPendiente?"S√≠":"No",
    };
  });
}

function doExport(fmt){
  const rows=getExportRows();
  if(!rows.length){alert("No hay personajes para exportar.");return;}
  const campVal=document.getElementById("exp-camp").value;
  const campName=campVal==="all"?"Todos":(campaigns.find(c=>c.id===parseInt(campVal))?.name||"export");
  const filename=`Gestor-DP-${campName.replace(/\s+/g,"-")}`;

  if(fmt==="csv"){
    const headers=Object.keys(rows[0]);
    const csv=[headers.join(","), ...rows.map(r=>headers.map(h=>`"${String(r[h]||"").replace(/"/g,'""')}"`).join(","))].join("\n");
    const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"});
    downloadBlob(blob, filename+".csv");
  } else {
    // XLSX manual (simple XML-based)
    const headers=Object.keys(rows[0]);
    const xmlRows=rows.map(r=>`<Row>${headers.map(h=>`<Cell><Data ss:Type="String">${escXml(String(r[h]||""))}</Data></Cell>`).join("")}</Row>`).join("");
    const headerRow=`<Row>${headers.map(h=>`<Cell ss:StyleID="h"><Data ss:Type="String">${escXml(h)}</Data></Cell>`).join("")}</Row>`;
    const xml=`<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"><Styles><Style ss:ID="h"><Font ss:Bold="1"/><Interior ss:Color="#1a2130" ss:Pattern="Solid"/></Style></Styles><Worksheet ss:Name="Personajes"><Table>${headerRow}${xmlRows}</Table></Worksheet></Workbook>`;
    const blob=new Blob([xml],{type:"application/vnd.ms-excel;charset=utf-8"});
    downloadBlob(blob, filename+".xls");
  }
  closeExport();
  showToast("‚úì Archivo descargado");
}

function escXml(s){ return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function downloadBlob(blob,name){
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href);
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ
function showToast(msg, success=true){
  let t=document.getElementById("toast");
  if(!t){t=document.createElement("div");t.id="toast";t.style.cssText="position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:'Cinzel',serif;font-size:11px;letter-spacing:.1em;padding:10px 20px;border-radius:10px;z-index:500;transition:opacity .4s;pointer-events:none";document.body.appendChild(t);}
  t.textContent=msg;
  t.style.borderColor=success?"rgba(76,168,76,.5)":"var(--border2)";
  t.style.color=success?"var(--green2)":"var(--text2)";
  t.style.opacity="1";
  clearTimeout(t._to);t._to=setTimeout(()=>t.style.opacity="0",2000);
}

// ‚îÄ‚îÄ‚îÄ INVENTORY RENDER ‚îÄ‚îÄ‚îÄ
function renderInvGrid(campId){
  const grid=document.getElementById(`inv-grid${campId}`);
  const countEl=document.getElementById(`inv-count${campId}`);
  if(!grid) return;
  const items=ITEMS.filter(i=>i.camp===campId);
  if(countEl) countEl.textContent=items.length;
  grid.innerHTML="";
  if(!items.length){
    grid.innerHTML='<div class="inv-empty">Sin art√≠culos en el inventario.</div>';
    return;
  }
  items.forEach(item=>{
    const div=document.createElement("div");
    div.className="icard";
    div.id=`icard-${item.id}`;
    const imgHtml=item.img
      ?`<img class="icard-img" src="${item.img}" alt="${item.name}">`
      :`<div class="icard-img-placeholder">üì¶</div>`;
    div.innerHTML=`
      <button class="icard-edit" title="Editar art√≠culo">‚úèÔ∏è</button>
      ${imgHtml}
      <div class="icard-body">
        <div class="icard-name">${item.name}</div>
        <div class="icard-desc">${item.desc||'<span style="color:var(--text3)">Sin descripci√≥n.</span>'}</div>
        <div class="icard-qty"><span class="ql">Cant.</span><span class="qn">${item.qty}</span></div>
      </div>`;
    div.querySelector(".icard-edit").addEventListener("click",e=>{e.stopPropagation();openEditItem(item.id);});
    if(!isLoggedIn) div.querySelector(".icard-edit").style.display="none";
    grid.appendChild(div);
  });
}

function openNewItem(campId){
  editingItemId=null; pendingItemImg="";
  document.getElementById("item-modal-title").textContent="Nuevo Art√≠culo";
  document.getElementById("item-btn-del").style.display="none";
  document.getElementById("if_name").value="";
  document.getElementById("if_desc").value="";
  document.getElementById("if_qty").value="1";
  const prev=document.getElementById("item-img-prev");
  prev.innerHTML=""; document.getElementById("item-img-txt").textContent="Clic o arrastra una imagen";
  document.getElementById("itemModal").dataset.camp=campId;
  document.getElementById("itemModal").classList.add("open");
  setTimeout(()=>document.getElementById("if_name").focus(),50);
}

function openEditItem(id){
  const item=ITEMS.find(i=>i.id===id); if(!item) return;
  editingItemId=id; pendingItemImg="";
  document.getElementById("item-modal-title").textContent=`Editar: ${item.name}`;
  document.getElementById("item-btn-del").style.display="block";
  document.getElementById("if_name").value=item.name;
  document.getElementById("if_desc").value=item.desc||"";
  document.getElementById("if_qty").value=item.qty;
  const prev=document.getElementById("item-img-prev");
  if(item.img){prev.innerHTML=`<img class="img-prev" src="${item.img}">`;document.getElementById("item-img-txt").textContent="Clic para cambiar";}
  else{prev.innerHTML="";document.getElementById("item-img-txt").textContent="Clic o arrastra una imagen";}
  document.getElementById("itemModal").dataset.camp=item.camp;
  document.getElementById("itemModal").classList.add("open");
}

function closeItemModal(){
  document.getElementById("itemModal").classList.remove("open");
  editingItemId=null; pendingItemImg="";
}

function itemQtyAdj(delta){
  const el=document.getElementById("if_qty");
  el.value=Math.max(0,(parseInt(el.value)||0)+delta);
}

function onItemImgUpload(input){
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    pendingItemImg=e.target.result;
    document.getElementById("item-img-prev").innerHTML=`<img class="img-prev" src="${pendingItemImg}">`;
    document.getElementById("item-img-txt").textContent="Clic para cambiar";
  };
  reader.readAsDataURL(file);
}

async function saveItem(){
  const name=document.getElementById("if_name").value.trim();
  if(!name){alert("El nombre es obligatorio.");return;}
  const desc=document.getElementById("if_desc").value.trim();
  const qty=parseInt(document.getElementById("if_qty").value)||0;
  const campId=parseInt(document.getElementById("itemModal").dataset.camp);
  const imgData=pendingItemImg||(editingItemId?ITEMS.find(i=>i.id===editingItemId)?.img:"");
  showToast("Guardando‚Ä¶",false);
  if(editingItemId){
    await sbFetch("items?id=eq."+editingItemId,{method:"PATCH",body:JSON.stringify({name,description:desc,qty,img:imgData||""})});
    const idx=ITEMS.findIndex(i=>i.id===editingItemId);
    if(idx>=0) ITEMS[idx]={...ITEMS[idx],name,desc,qty,img:imgData||""};
  } else {
    const newId="item_"+Date.now();
    await sbFetch("items",{method:"POST",body:JSON.stringify({id:newId,camp:campId,name,description:desc,qty,img:imgData||""})});
    ITEMS.push({id:newId,camp:campId,name,desc,qty,img:imgData||""});
  }
  showToast("‚úì Guardado");
  pendingItemImg=""; closeItemModal(); renderInvGrid(campId);
}

async function deleteItem(){
  if(!editingItemId) return;
  const item=ITEMS.find(i=>i.id===editingItemId);
  if(!confirm(`¬øEliminar "${item?.name}"? No se puede deshacer.`)) return;
  await sbFetch("items?id=eq."+editingItemId,{method:"DELETE"});
  const campId=item.camp;
  ITEMS=ITEMS.filter(i=>i.id!==editingItemId);
  showToast("‚úì Eliminado"); closeItemModal(); renderInvGrid(campId);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
async function init(){
  showToast("Cargando datos‚Ä¶", false);

  // load campaigns
  const campRows = await sbFetch("campaigns?select=*&order=id");
  if(campRows && campRows.length){
    campaigns = campRows.map(r=>({id:r.id, name:r.name}));
  }

  // load NPCs from Supabase
  const npcRows = await sbFetch("npcs?select=*&order=camp,name");
  if(npcRows && npcRows.length){
    NPCS = npcRows.map(rowToNPC);
  }
  // if no NPCs in DB yet, seed with default data then push to Supabase
  else {
    showToast("Subiendo datos iniciales‚Ä¶", false);
    for(const n of NPCS){
      await sbFetch("npcs",{method:"POST",body:JSON.stringify(npcToRow(n))});
    }
    showToast("‚úì Datos iniciales guardados");
  }

  // load items from Supabase
  const itemRows = await sbFetch("items?select=*&order=camp,name");
  if(itemRows && itemRows.length){
    ITEMS = itemRows.map(r=>({id:r.id,camp:r.camp,name:r.name,desc:r.description||"",qty:r.qty||0,img:r.img||""}));
  }

  campaigns.forEach(c=>activeFaction[c.id]=null);
  fullRender();
  document.querySelectorAll(".cedit").forEach(b=>b.style.display="none");
  document.querySelectorAll(".edit-cn-btn").forEach(b=>b.style.display="none");
  document.querySelectorAll(".icard-edit").forEach(b=>b.style.display="none");
  document.querySelectorAll(".btn-new-item").forEach(b=>b.style.display="none");
  showToast("‚úì Listo");
}

init();
</script>
</body>
</html>